PrivateJainSipCallConnector=function(a,c,b){console.debug("PrivateJainSipCallConnector:PrivateJainSipCallConnector()");if(c instanceof WebRtcCommCall){if(typeof(b)=="string"){this.sipCallId=b}else{this.sipCallId=new String(new Date().getTime())}this.clientConnector=a;this.webRtcCommCall=c;this.webRtcCommCall.id=this.sipCallId;this.configuration=undefined;this.resetSipContext()}else{throw"PrivateJainSipCallConnector:PrivateJainSipCallConnector(): bad arguments"}};PrivateJainSipCallConnector.prototype.SIP_INVITING_INITIAL_STATE="INVITING_INITIAL_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_STATE="INVITING_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_407_STATE="INVITING_407_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_ACCEPTED_STATE="INVITING_ACCEPTED_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_LOCAL_HANGINGUP_STATE="INVITING_LOCAL_HANGINGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_LOCAL_HANGINGUP_407_STATE="INVITING_LOCAL_HANGINGUP_407_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_CANCELLING_STATE="INVITING_CANCELLING_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_ERROR_STATE="INVITING_ERROR_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_HANGUP_STATE="INVITING_HANGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_CANCELLED_STATE="SIP_INVITING_CANCELLED_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_INITIAL_STATE="INVITED_INITIAL_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_ACCEPTED_STATE="INVITED_ACCEPTED_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_LOCAL_HANGINGUP_STATE="INVITED_LOCAL_HANGINGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_LOCAL_HANGINGUP_407_STATE="INVITED_LOCAL_HANGINGUP_407_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_HANGUP_STATE="INVITED_HANGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_ERROR_STATE="INVITED_ERROR_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_CANCELLED_STATE="INVITING_HANGUP_STATE";PrivateJainSipCallConnector.prototype.isOpened=function(){return((this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE)||(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE))};PrivateJainSipCallConnector.prototype.getId=function(){return this.sipCallId};PrivateJainSipCallConnector.prototype.open=function(a){console.debug("PrivateJainSipCallConnector:open()");if(this.sipCallState==undefined){if(typeof(a)=="object"){if(this.checkConfiguration(a)==true){this.sipCallState=this.SIP_INVITING_INITIAL_STATE;this.configuration=a}else{console.error("PrivateJainSipCallConnector:open(): bad configuration");throw"PrivateJainSipCallConnector:open(): bad configuration"}}else{this.sipCallState=SIP_INVITED_INITIAL_STATE}}else{console.error("PrivateJainSipCallConnector:open(): bad state, unauthorized action");throw"PrivateJainSipCallConnector:open(): bad state, unauthorized action"}};PrivateJainSipCallConnector.prototype.close=function(){console.debug("PrivateJainSipCallConnector:close(): this.sipCallState="+this.sipCallState);if(this.sipCallState!=undefined){try{if(this.sipCallState==this.SIP_INITIAL_INVITING_STATE){this.resetSipContext();this.clientConnector.removeCallConnector(this.sipCallId);this.webRtcCommCall.onPrivateCallConnectorCallClosedEvent()}else{if(this.sipCallState==this.SIP_INVITING_STATE||this.sipCallState==this.SIP_INVITING_407_STATE){this.jainSipInvitingCancelRequest=this.jainSipInvitingTransaction.createCancel();this.jainSipInvitingCancelRequest.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitingCancelTransaction=this.clientConnector.jainSipProvider.getNewClientTransaction(this.jainSipInvitingCancelRequest);this.jainSipInvitingCancelTransaction.sendRequest();this.sipCallState=this.SIP_INVITING_CANCELLING_STATE}else{if(this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE){var c=this.jainSipInvitingDialog.createRequest("BYE");c.removeHeader("Contact");c.removeHeader("User-Agent");c.addHeader(this.clientConnector.jainSipContactHeader);var a=this.clientConnector.jainSipProvider.getNewClientTransaction(c);this.jainSipInvitingDialog.sendRequest(a);this.sipCallState=this.SIP_INVITING_LOCAL_HANGINGUP_STATE;this.webRtcCommCall.onPrivateCallConnectorCallClosedEvent()}else{if(this.sipCallState==this.SIP_INVITED_INITIAL_STATE){var d=this.jainSipInvitedRequest.createResponse(480,"Temporarily Unavailable");d.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitedTransaction.sendResponse(d);this.resetSipContext();this.clientConnector.removeCallConnector(this.sipCallId)}else{if(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE){var c=this.jainSipInvitedDialog.createRequest("BYE");c.removeHeader("Contact");c.removeHeader("User-Agent");c.addHeader(this.clientConnector.jainSipContactHeader);var a=this.clientConnector.jainSipProvider.getNewClientTransaction(c);this.jainSipInvitedDialog.sendRequest(a);this.sipCallState=this.SIP_INVITED_LOCAL_HANGINGUP_STATE}else{this.resetSipContext();this.clientConnector.removeCallConnector(this.sipCallId);this.webRtcCommCall.onPrivateCallConnectorCallClosedEvent()}}}}}}catch(b){console.error("PrivateJainSipCallConnector:close(): catched exception:"+b);this.resetSipContext();this.clientConnector.removeCallConnector(this.sipCallId);this.webRtcCommCall.onPrivateCallConnectorCallClosedEvent()}}};PrivateJainSipCallConnector.prototype.reject=function(){console.debug("PrivateJainSipCallConnector:reject()");if(this.sipCallState==this.SIP_INVITED_INITIAL_STATE){try{var a=this.jainSipInvitedRequest.createResponse(486,"Busy here");a.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitedTransaction.sendResponse(a)}catch(b){console.error("PrivateJainSipCallConnector:reject(): catched exception:"+b)}this.close()}else{console.error("PrivateJainSipCallConnector:reject(): bad state, unauthorized action");throw"PrivateJainSipCallConnector:reject(): bad state, unauthorized action"}};PrivateJainSipCallConnector.prototype.checkConfiguration=function(b){console.debug("PrivateJainSipCallConnector:checkConfiguration()");var a=true;return a};PrivateJainSipCallConnector.prototype.resetSipContext=function(){console.debug("PrivateJainSipCallConnector:resetSipContext()");this.sipCallState=undefined;this.sdpOffer=undefined;this.jainSipAuthorizationHeader=undefined;this.jainSipInvitingSentRequest=undefined;this.jainSipInvitingDialog=undefined;this.jainSipInvitingTransaction=undefined;this.jainSipInvitedReceivedRequest=undefined;this.jainSipInvitedDialog=undefined;this.jainSipInvitedTransaction=undefined};PrivateJainSipCallConnector.prototype.invite=function(a){console.debug("PrivateJainSipCallConnector:invite()");this.sdpOffer=a;this.sendSipInviteRequest(a);this.sipCallState=this.SIP_INVITING_STATE};PrivateJainSipCallConnector.prototype.accept=function(a){console.debug("PrivateJainSipCallConnector:accept()");var b=this.jainSipInvitedRequest.createResponse(200,"OK");b.addHeader(this.clientConnector.jainSipContactHeader);b.setMessageContent("application","sdp",a);this.jainSipInvitedTransaction.sendResponse(b);this.sipCallState=this.SIP_INVITED_ACCEPTED_STATE};PrivateJainSipCallConnector.prototype.onJainSipClientConnectorSipRequestEvent=function(a){console.debug("PrivateJainSipCallConnector:onJainSipClientConnectorSipRequestEvent()");if(this.jainSipInvitingDialog!=undefined){this.processInvitingSipRequestEvent(a)}else{if(this.jainSipInvitedDialog!=undefined){this.processInvitedSipRequestEvent(a)}else{this.processInvitedSipRequestEvent(a)}}};PrivateJainSipCallConnector.prototype.onJainSipClientConnectorSipResponseEvent=function(a){console.debug("PrivateJainSipCallConnector:onJainSipClientConnectorSipResponseEvent()");if(this.jainSipInvitingDialog!=undefined){this.processInvitingSipResponseEvent(a)}else{if(this.jainSipInvitedDialog!=undefined){this.processInvitedSipResponseEvent(a)}else{console.warn("PrivateJainSipCallConnector:onJainSipClientConnectorSipResponseEvent(): response ignored")}}};PrivateJainSipCallConnector.prototype.onJainSipClientConnectorSipTimeoutEvent=function(a){console.debug("PrivateJainSipCallConnector:onJainSipClientConnectorSipTimeoutEvent()");this.close()};PrivateJainSipCallConnector.prototype.processInvitingSipRequestEvent=function(a){console.debug("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): this.sipCallState="+this.sipCallState);var c=a.getRequest();var d=c.getMethod();if(this.sipCallState==this.SIP_INVITING_INITIAL_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_407_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_FAILED_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE){if(d=="BYE"){try{var e=c.createResponse(200,"OK");e.addHeader(this.clientConnector.jainSipContactHeader);a.getServerTransaction().sendResponse(e);this.sipCallState=this.SIP_INVITING_HANGUP_STATE}catch(b){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception exception:"+b)}this.webRtcCommCall.onPrivateCallConnectorCallHangupEvent();this.close()}else{console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}}else{console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}}}}}};PrivateJainSipCallConnector.prototype.sendSipInviteRequest=function(){console.debug("PrivateJainSipCallConnector:sendSipInviteRequest()");var f=this.webRtcCommCall.getCalleePhoneNumber();if(f.indexOf("@")==-1){f+="@"+this.clientConnector.configuration.sipDomain}var a=this.clientConnector.configuration.sipUserName+"@"+this.clientConnector.configuration.sipDomain;var k=this.clientConnector.jainSipHeaderFactory.createCSeqHeader(1,"INVITE");var p=this.clientConnector.jainSipHeaderFactory.createCallIdHeader(this.sipCallId);var h=this.clientConnector.jainSipHeaderFactory.createMaxForwardsHeader(70);var d=this.clientConnector.jainSipAddressFactory.createSipURI_user_host(null,f);var j=this.clientConnector.jainSipHeaderFactory.createHeaders("Allow: INVITE,ACK,CANCEL,BYE");var b=this.clientConnector.jainSipAddressFactory.createSipURI_user_host(null,a);var g=this.clientConnector.jainSipAddressFactory.createAddress_name_uri(this.configuration.displayName,b);var n=new Date().getTime();var i=this.clientConnector.jainSipHeaderFactory.createFromHeader(g,n);var m=this.clientConnector.jainSipAddressFactory.createSipURI_user_host(null,f);var c=this.clientConnector.jainSipAddressFactory.createAddress_name_uri(null,m);var e=this.clientConnector.jainSipHeaderFactory.createToHeader(c,null);var l=this.clientConnector.jainSipListeningPoint.getViaHeader();var o=this.clientConnector.jainSipHeaderFactory.createContentTypeHeader("application","sdp");this.jainSipInvitingRequest=this.clientConnector.jainSipMessageFactory.createRequest(d,"INVITE",p,k,i,e,l,h,o,this.sdpOffer);this.clientConnector.jainSipMessageFactory.addHeader(this.jainSipInvitingRequest,j);this.clientConnector.jainSipMessageFactory.addHeader(this.jainSipInvitingRequest,this.clientConnector.jainSipContactHeader);if(this.jainSipAuthorizationHeader){this.clientConnector.jainSipMessageFactory.addHeader(this.jainSipInvitingRequest,this.jainSipAuthorizationHeader)}this.jainSipInvitingTransaction=this.clientConnector.jainSipProvider.getNewClientTransaction(this.jainSipInvitingRequest);this.jainSipInvitingRequest.setTransaction(this.jainSipInvitingTransaction);this.jainSipInvitingDialog=this.jainSipInvitingTransaction.getDialog();this.jainSipInvitingTransaction.sendRequest()};PrivateJainSipCallConnector.prototype.processInvitingSipResponseEvent=function(b){console.debug("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): this.sipCallState="+this.sipCallState);var g=b.getResponse();var d=parseInt(g.getStatusCode());if(this.sipCallState==this.SIP_INVITING_STATE){if(d<200){if(d==180){this.webRtcCommCall.onPrivateCallConnectorCallRingingBackEvent()}else{if(d==183){this.webRtcCommCall.onPrivateCallConnectorCallInProgressEvent()}}console.debug("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): 1XX response ignored")}else{if(d==407){this.jainSipAuthorizationHeader=this.clientConnector.jainSipHeaderFactory.createAuthorizationHeader(g,this.jainSipInvitingRequest,this.clientConnector.configuration.sipPassword,this.clientConnector.configuration.sipLogin);this.sendSipInviteRequest();this.sipCallState=this.SIP_INVITING_407_STATE}else{if(d==200){this.jainSipInvitingDialog=b.getOriginalTransaction().getDialog();try{this.jainSipInvitingDialog.setRemoteTarget(g.getHeader("Contact"));var e=this.jainSipInvitingTransaction.createAck();e.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitingDialog.sendAck(e);this.sipCallState=this.SIP_INVITING_ACCEPTED_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c)}try{var f=g.getContent();this.webRtcCommCall.onPrivateCallConnectorRemoteSdpAnswerEvent(f)}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c);this.webRtcCommCall.onPrivateCallConnectorCallOpenErrorEvent(c);this.close()}}else{console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): SIP INVITE failed:"+g.getStatusCode()+"  "+g.getStatusLine().toString());this.sipCallState=this.SIP_INVITING_ERROR_STATE;this.webRtcCommCall.onPrivateCallConnectorCallOpenErrorEvent(g.getStatusLine().getReasonPhrase());this.close()}}}}else{if(this.sipCallState==this.SIP_INVITING_CANCELLING_STATE){this.sipCallState=this.SIP_INVITING_CANCELLED_STATE;this.close()}else{if(this.sipCallState==this.SIP_INVITING_407_STATE){if(d<200){console.debug("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): 1XX response ignored")}else{if(d==200){this.jainSipInvitingDialog=b.getOriginalTransaction().getDialog();try{this.jainSipInvitingDialog.setRemoteTarget(g.getHeader("Contact"));var e=this.jainSipInvitingTransaction.createAck();e.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitingDialog.sendAck(e);this.sipCallState=this.SIP_INVITING_ACCEPTED_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c)}try{var f=g.getContent();this.webRtcCommCall.onPrivateCallConnectorRemoteSdpAnswerEvent(f)}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c);this.webRtcCommCall.onPrivateCallConnectorCallOpenErrorEvent(c);this.close()}}else{this.sipCallState=this.SIP_INVITING_ERROR_STATE;this.webRtcCommCall.onPrivateCallConnectorCallOpenErrorEvent(g.getStatusLine().getReasonPhrase());this.close()}}}else{if(this.sipCallState==this.SIP_INVITING_FAILED_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITING_LOCAL_HANGINGUP_STATE){if(d==407){try{var a=this.jainSipInvitingDialog.createRequest("BYE");var h=this.clientConnector.jainSipProvider.getNewClientTransaction(a);var i=this.clientConnector.jainSipHeaderFactory.createAuthorizationHeader(g,a,this.clientConnector.configuration.sipPassword,this.clientConnector.configuration.sipLogin);this.clientConnector.jainSipMessageFactory.addHeader(a,i);this.jainSipInvitingDialog.sendRequest(h);this.sipCallState=this.SIP_INVITING_HANGINGUP_407_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c);this.close()}}else{this.close()}}else{if(this.sipCallState==this.SIP_INVITING_LOCAL_HANGINGUP_407_STATE){this.close()}else{console.error("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): bad state, SIP response ignored")}}}}}}}};PrivateJainSipCallConnector.prototype.processInvitedSipRequestEvent=function(c){console.debug("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): this.sipCallState="+this.sipCallState);var a=c.getRequest();var e=a.getMethod();var d=a.getHeader("From");if(this.sipCallState==this.SIP_INVITED_INITIAL_STATE){if(e=="INVITE"){try{this.jainSipInvitedRequest=a;this.jainSipInvitedTransaction=c.getServerTransaction();this.jainSipInvitedDialog=c.getServerTransaction().getDialog();var j=a.createResponse(180,"Ringing");j.addHeader(this.clientConnector.jainSipContactHeader);c.getServerTransaction().sendResponse(j)}catch(b){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): catched exception, exception:"+b)}this.webRtcCommCall.onPrivateCallConnectorRemoteSdpOfferEvent(this.jainSipInvitedRequest.getContent());var f=this;var i=d.getAddress().getURI().getUser();this.webRtcCommCall.onPrivateCallConnectorCallRingingEvent(i)}else{if(e=="CANCEL"){try{var g=a.createResponse(200,"OK");g.addHeader(this.clientConnector.jainSipContactHeader);c.getServerTransaction().sendResponse(g);var h=this.jainSipInvitedRequest.createResponse(487,"(Request Cancelled)");this.jainSipInvitedTransaction.sendMessage(h);this.sipCallState=this.SIP_INVITED_CANCELLED_STATE}catch(b){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): catched exception, exception:"+b)}this.webRtcCommCall.onPrivateCallConnectorCallHangupEvent();this.close()}else{console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}}}else{if(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE){if(e=="BYE"){try{var g=a.createResponse(200,"OK");g.addHeader(this.clientConnector.jainSipContactHeader);c.getServerTransaction().sendResponse(g);this.sipCallState=this.SIP_INVITED_HANGUP_STATE}catch(b){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): catched exception exception:"+b)}this.webRtcCommCall.onPrivateCallConnectorCallHangupEvent();this.close()}else{if(e=="ACK"){this.jainSipInvitedDialog=c.getServerTransaction().getDialog()}else{console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}}}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_407_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}}}}};PrivateJainSipCallConnector.prototype.processInvitedSipResponseEvent=function(f){console.debug("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): this.invitingState="+this.invitingState);var g=f.getResponse();var e=parseInt(g.getStatusCode());if(this.sipCallState==this.SIP_INVITED_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_STATE){if(e==407){try{var d=this.jainSipInvitedDialog.createRequest("BYE");var a=this.jainSipProvider.getNewClientTransaction(d);var b=this.jainSipHeaderFactory.createAuthorizationHeader(g,d,this.configuration.sipPassword,this.configuration.sipLogin);this.jainSipMessageFactory.addHeader(d,b);d.addHeader(this.clientConnector.jainSipContactHeader);this.jainSipInvitedDialog.sendRequest(a);this.sipCallState=this.SIP_INVITED_HANGINGUP_407_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): catched exception, exception:"+c);this.close()}}else{this.close()}}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_407_STATE){this.close()}else{console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): bad state, SIP request ignored")}}}}};PrivateJainSipClientConnector=function(a){console.debug("PrivateJainSipClientConnector:PrivateJainSipClientConnector()");if(a instanceof WebRtcCommClient){this.webRtcCommClient=a;this.reset()}else{throw"PrivateJainSipClientConnector:PrivateJainSipClientConnector(): bad arguments"}};PrivateJainSipClientConnector.prototype.SIP_ALLOW_HEADER="Allow: INVITE,ACK,CANCEL,BYE, OPTIONS";PrivateJainSipClientConnector.prototype.SIP_UNREGISTERED_STATE="SIP_UNREGISTERED_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTERING_STATE="SIP_REGISTERING_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTER_REFRESHING_STATE="SIP_REGISTER_REFRESHING_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTERING_401_STATE="SIP_REGISTERING_401_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTERED_STATE="SIP_REGISTERED_STATE";PrivateJainSipClientConnector.prototype.SIP_UNREGISTERING_401_STATE="SIP_UNREGISTERING_401_STATE";PrivateJainSipClientConnector.prototype.SIP_UNREGISTERING_STATE="SIP_UNREGISTERING_STATE";PrivateJainSipClientConnector.prototype.SIP_SESSION_EXPIRATION_TIMER=3600;PrivateJainSipClientConnector.prototype.isOpened=function(){return this.openedFlag};PrivateJainSipClientConnector.prototype.open=function(b){console.debug("PrivateJainSipClientConnector:open()");try{if(typeof(b)=="object"){if(this.openedFlag==false){if(this.checkConfiguration(b)==true){this.configuration=b;this.jainSipFactory=new SipFactory();this.jainSipStack=this.jainSipFactory.createSipStack(this.configuration.sipUserAgent);this.jainSipListeningPoint=this.jainSipStack.createListeningPoint(this.configuration.sipOutboundProxy);this.jainSipProvider=this.jainSipStack.createSipProvider(this.jainSipListeningPoint);this.jainSipProvider.addSipListener(this);this.jainSipHeaderFactory=this.jainSipFactory.createHeaderFactory();this.jainSipAddressFactory=this.jainSipFactory.createAddressFactory();this.jainSipMessageFactory=this.jainSipFactory.createMessageFactory();this.jainSipContactHeader=this.jainSipListeningPoint.createContactHeader(this.configuration.sipUserName);if(this.configuration.sipUserAgentCapabilities){this.jainSipContactHeader.setParameter(this.configuration.sipUserAgentCapabilities,null)}this.jainSipMessageFactory.setDefaultUserAgentHeader(this.jainSipHeaderFactory.createUserAgentHeader(this.jainSipStack.getUserAgent()));this.jainSipStack.start()}else{console.error("PrivateJainSipClientConnector:open(): bad configuration");throw"PrivateJainSipClientConnector:open(): bad configuration"}}else{console.error("PrivateJainSipClientConnector:open(): bad state, unauthorized action");throw"PrivateJainSipClientConnector:open(): bad state, unauthorized action"}}else{console.error("PrivateJainSipClientConnector:open(): bad argument, check API documentation");throw"PrivateJainSipClientConnector:open(): bad argument, check API documentation"}}catch(a){this.reset();console.error("PrivateJainSipClientConnector:open(): catched exception:"+a);throw a}};PrivateJainSipClientConnector.prototype.close=function(){console.debug("PrivateJainSipClientConnector:close()");try{if(this.openedFlag==true){for(var a in this.callConnectors){var c=this.findCallConnector(a);if(c.isOpened()){c.close()}}if(this.configuration.sipRegisterMode==true){if(this.sipRegisterState==this.SIP_REGISTERED_STATE){this.sipUnregisterPendingFlag=false;this.sipRegisterState=this.SIP_UNREGISTERING_STATE;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sendSipRegisterRequest(0)}else{this.sipUnregisterPendingFlag=true}}else{this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}}else{console.error("PrivateJainSipClientConnector:close(): bad state, unauthorized action");throw"PrivateJainSipClientConnector:close(): bad state, unauthorized action"}}catch(b){console.error("PrivateJainSipClientConnector:close(): catched exception:"+b);throw b}};PrivateJainSipClientConnector.prototype.createPrivateCallConnector=function(d,a){console.debug("PrivateJainSipClientConnector:createPrivateCallConnector()");try{if(d instanceof WebRtcCommCall){if(this.openedFlag==true){var c=new PrivateJainSipCallConnector(this,d,a);c.clientConnector=this;this.callConnectors[c.sipCallId]=c;return c}else{console.error("PrivateJainSipClientConnector:createPrivateCallConnector(): bad state, unauthorized action");throw"PrivateJainSipClientConnector:createPrivateCallConnector(): bad state, unauthorized action"}}else{console.error("PrivateJainSipClientConnector:createPrivateCallConnector(): bad argument, check API documentation");throw"PrivateJainSipClientConnector:createPrivateCallConnector(): bad argument, check API documentation"}}catch(b){console.error("PrivateJainSipClientConnector:createPrivateCallConnector(): catched exception:"+b);throw b}};PrivateJainSipClientConnector.prototype.findCallConnector=function(a){console.debug("PrivateJainSipClientConnector:findCallConnector(): sipCallId="+a);return this.callConnectors[a]};PrivateJainSipClientConnector.prototype.removeCallConnector=function(a){console.debug("PrivateJainSipClientConnector:removeCallConnector(): sipCallId="+a);delete this.callConnectors.sipCallId};PrivateJainSipClientConnector.prototype.reset=function(){console.debug("PrivateJainSipClientConnector:reset()");this.openedFlag=false;this.configuration=undefined;this.resetSipRegisterContext();this.callConnectors={}};PrivateJainSipClientConnector.prototype.resetSipRegisterContext=function(){console.debug("PrivateJainSipClientConnector:resetSipRegisterContext()");if(this.sipRegisterRefreshTimer!=undefined){clearTimeout(this.sipRegisterRefreshTimer)}this.sipRegisterState=this.SIP_UNREGISTERED_STATE;this.sipRegisterRefreshTimer=undefined;this.sipRegisterAuthenticatedFlag=false;this.jainSipRegisterRequest=undefined;this.jainSipRegisterTransaction=undefined;this.jainSipRegisterDialog=undefined;this.sipUnregisterPendingFlag=false;this.jainSipAuthorizationHeader=undefined};PrivateJainSipClientConnector.prototype.checkConfiguration=function(c){console.debug("PrivateJainSipClientConnector:checkConfiguration()");try{var a=true;if(c.sipUserAgent==undefined||c.sipUserAgent.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipUserAgent")}if(c.sipOutboundProxy==undefined||c.sipOutboundProxy.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipOutboundProxy")}if(c.sipDomain==undefined||c.sipDomain.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipDomain")}if(c.sipUserName==undefined||c.sipUserName.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipUserName")}if(c.sipRegisterMode==undefined||c.sipRegisterMode.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipRegisterMode")}if(c.sipLogin!=undefined&&c.sipLogin==""){c.sipLogin=undefined}if(c.sipPassword!=undefined&&c.sipPassword==""){c.sipPassword=undefined}if(c.sipUserAgentCapabilities!=undefined&&c.sipUserAgentCapabilities==""){c.sipUserAgentCapabilities=undefined}console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipUserAgent:"+c.sipUserAgent);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipUserAgentCapabilities:"+c.sipUserAgentCapabilities);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipOutboundProxy:"+c.sipOutboundProxy);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipDomain:"+c.sipDomain);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipUserName:"+c.sipUserName);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipLogin:"+c.sipLogin);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipPassword: "+c.sipPassword);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipRegisterMode:"+c.sipRegisterMode);return a}catch(b){console.error("PrivateJainSipClientConnector:checkConfiguration(): catched exception:"+b);return false}};PrivateJainSipClientConnector.prototype.processConnected=function(){console.debug("PrivateJainSipClientConnector:processConnected()");try{if(this.openedFlag==false){if(this.configuration.sipRegisterMode==true){this.resetSipRegisterContext();this.sendSipRegisterRequest(this.SIP_SESSION_EXPIRATION_TIMER);this.sipRegisterState=this.SIP_REGISTERING_STATE;return}else{this.openedFlag=true;this.webRtcCommClient.onPrivateClientConnectorOpenedEvent();return}}else{console.error("PrivateJainSipClientConnector:processConnected(): this.openedFlag==true !")}this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}catch(a){this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent();console.error("PrivateJainSipClientConnector:processConnected(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.sendSipRegisterRequest=function(m){console.debug("PrivateJainSipClientConnector:sendSipRegisterRequest()");var a=this.configuration.sipUserName+"@"+this.configuration.sipDomain;var k=this.jainSipHeaderFactory.createCSeqHeader(1,"REGISTER");var o=this.jainSipHeaderFactory.createCallIdHeader(new String(new Date().getTime()));var c=this.jainSipHeaderFactory.createExpiresHeader(m);var g=this.jainSipHeaderFactory.createMaxForwardsHeader(70);var d=this.jainSipAddressFactory.createSipURI_user_host(null,this.configuration.sipDomain);var j=this.jainSipHeaderFactory.createHeaders(PrivateJainSipClientConnector.prototype.SIP_ALLOW_HEADER);var b=this.jainSipAddressFactory.createSipURI_user_host(null,a);var h=this.jainSipAddressFactory.createAddress_name_uri(null,b);var e=new Date();var n=e.getTime();var i=this.jainSipHeaderFactory.createFromHeader(h,n);var f=this.jainSipHeaderFactory.createToHeader(h,null);var l=this.jainSipListeningPoint.getViaHeader();this.jainSipRegisterRequest=this.jainSipMessageFactory.createRequest(d,"REGISTER",o,k,i,f,l,g);this.jainSipMessageFactory.addHeader(this.jainSipRegisterRequest,c);this.jainSipMessageFactory.addHeader(this.jainSipRegisterRequest,j);this.jainSipMessageFactory.addHeader(this.jainSipRegisterRequest,this.jainSipContactHeader);if(this.jainSipAuthorizationHeader){this.jainSipMessageFactory.addHeader(this.jainSipRegisterRequest,this.jainSipAuthorizationHeader)}this.jainSipRegisterTransaction=this.jainSipProvider.getNewClientTransaction(this.jainSipRegisterRequest);this.jainSipRegisterDialog=this.jainSipRegisterTransaction.getDialog();this.jainSipRegisterRequest.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest()};PrivateJainSipClientConnector.prototype.processDisconnected=function(){console.debug("PrivateJainSipClientConnector:processDisconnected(): SIP connectivity has been lost");try{this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}catch(a){console.error("PrivateJainSipClientConnector:processDisconnected(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.processConnectionError=function(a){console.war("PrivateJainSipClientConnector:processConnectionError(): SIP connection has failed, error:"+a);try{this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}catch(b){console.error("PrivateJainSipClientConnector:processConnectionError(): catched exception:"+b)}};PrivateJainSipClientConnector.prototype.processRequest=function(a){console.debug("PrivateJainSipClientConnector:processRequest()");try{var f=a.getRequest();var e=f.getMethod();if(e=="OPTIONS"){this.processSipOptionRequest(a)}else{var c=f.getCallId().getCallId();var g=this.findCallConnector(c);if(g){g.onJainSipClientConnectorSipRequestEvent(a)}else{if(e=="INVITE"){var b=new WebRtcCommCall(this.webRtcCommClient);b.connector=this.createPrivateCallConnector(b,c);b.id=b.connector.getId();b.connector.sipCallState=PrivateJainSipCallConnector.prototype.SIP_INVITED_INITIAL_STATE;b.connector.onJainSipClientConnectorSipRequestEvent(a)}else{console.warn("PrivateJainSipClientConnector:processRequest(): SIP request ignored")}}}}catch(d){console.error("PrivateJainSipClientConnector:processRequest(): catched exception:"+d)}};PrivateJainSipClientConnector.prototype.processResponse=function(b){console.debug("PrivateJainSipClientConnector:processResponse()");try{var d=b.getResponse();if(d.getCSeq().getMethod()=="REGISTER"){this.processSipRegisterResponse(b)}else{var c=this.findCallConnector(d.getCallId().getCallId());if(c){c.onJainSipClientConnectorSipResponseEvent(b)}else{console.warn("PrivateJainSipClientConnector:processResponse(): PrivateJainSipCallConnector not found, SIP response ignored")}}}catch(a){console.error("PrivateJainSipClientConnector:processResponse(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.processTransactionTerminated=function(){console.debug("PrivateJainSipClientConnector:processTransactionTerminated()")};PrivateJainSipClientConnector.prototype.processDialogTerminated=function(){console.debug("PrivateJainSipClientConnector:processDialogTerminated()")};PrivateJainSipClientConnector.prototype.processIOException=function(a){console.error("PrivateJainSipClientConnector:processIOException(): exceptionEvent="+a.message)};PrivateJainSipClientConnector.prototype.processTimeout=function(a){console.debug("PrivateJainSipClientConnector:processTimeout():timeoutEvent="+a);try{var d=a.getClientTransaction();var b=d.getDialog().getCallId().getCallId();var e=this.findCallConnector(b,false);if(e){e.onJainSipClientConnectorSipTimeoutEvent(a)}else{if(this.jainSipRegisterRequest.getCallId().getCallId()==b){console.error("PrivateJainSipClientConnector:processTimeout(): SIP registration failed, request timeout, no response from SIP server");this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent("Request Timeout")}else{console.warn("PrivateJainSipClientConnector:processTimeout(): no dialog found, SIP timeout ignored")}}}catch(c){console.error("PrivateJainSipClientConnector:processTimeout(): catched exception:"+c)}};PrivateJainSipClientConnector.prototype.onSipRegisterTimeout=function(){console.debug("PrivateJainSipClientConnector:onSipRegisterTimeout()");try{if(this.sipRegisterState==this.SIP_REGISTERED_STATE){this.sipRegisterRefreshTimer=undefined;this.sipRegisterState=this.SIP_REGISTER_REFRESHING_STATE;this.sendSipRegisterRequest(this.SIP_SESSION_EXPIRATION_TIMER)}else{console.warn("PrivateJainSipClientConnector:onSipRegisterTimeout(): SIP REGISTER refresh stopped")}}catch(a){console.error("PrivateJainSipClientConnector:onSipRegisterTimeout(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.processSipRegisterResponse=function(c){console.debug("PrivateJainSipClientConnector:processSipRegisterResponse(): this.sipRegisterState="+this.sipRegisterState);var d=c.getResponse();var a=parseInt(d.getStatusCode());if(this.sipRegisterState==this.SIP_UNREGISTERED_STATE){console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}else{if((this.sipRegisterState==this.SIP_REGISTERING_STATE)||(this.sipRegisterState==this.SIP_REGISTER_REFRESHING_STATE)){if(a<200){console.debug("PrivateJainSipClientConnector:processSipRegisterResponse(): 1XX response ignored")}else{if(a==401){if(this.configuration.sipPassword!=undefined&&this.configuration.sipLogin!=undefined){this.sipRegisterState=this.SIP_REGISTERING_401_STATE;this.jainSipAuthorizationHeader=this.jainSipHeaderFactory.createAuthorizationHeader(d,this.jainSipRegisterRequest,this.configuration.sipPassword,this.configuration.sipLogin);this.sendSipRegisterRequest(this.SIP_SESSION_EXPIRATION_TIMER)}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP registration failed:"+d.getStatusCode()+"  "+d.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}}else{if(a==200){this.sipRegisterState=this.SIP_REGISTERED_STATE;if(this.openedFlag==false){this.openedFlag=true;this.webRtcCommClient.onPrivateClientConnectorOpenedEvent()}if(this.sipUnregisterPendingFlag==true){this.sipUnregisterPendingFlag=false;this.sipRegisterState=this.SIP_UNREGISTERING_STATE;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sendSipRegisterRequest(0)}else{var b=this;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sipRegisterRefreshTimer=setTimeout(function(){b.onSipRegisterTimeout()},40000)}}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP registration failed:"+d.getStatusCode()+"  "+d.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}}}}else{if(this.sipRegisterState==this.SIP_REGISTERING_401_STATE){if(a<200){}else{if(a==200){this.sipRegisterState=this.SIP_REGISTERED_STATE;if(this.openedFlag==false){console.debug("PrivateJainSipClientConnector:processSipRegisterResponse(): this.openedFlag=true");this.openedFlag=true;this.webRtcCommClient.onPrivateClientConnectorOpenedEvent()}if(this.sipUnregisterPendingFlag==true){this.sipUnregisterPendingFlag=false;this.sipRegisterState=this.SIP_UNREGISTERING_STATE;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sendSipRegisterRequest(0)}else{var b=this;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sipRegisterRefreshTimer=setTimeout(function(){b.onSipRegisterTimeout()},40000)}}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP registration failed:"+d.getStatusCode()+"  "+d.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}}}else{if(this.sipRegisterState==this.SIP_REGISTERED_STATE){console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}else{if(this.sipRegisterState==this.SIP_UNREGISTERING_STATE){if(a<200){}else{if(a==401){this.sipRegisterState=this.SIP_UNREGISTERING_401_STATE;this.jainSipRegisterRequest.removeHeader("Authorization");this.jainSipAuthorizationHeader=this.jainSipHeaderFactory.createAuthorizationHeader(d,this.jainSipRegisterRequest,this.configuration.sipPassword,this.configuration.sipLogin);this.sendSipRegisterRequest(0)}else{if(a==200){this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP unregistration failed:"+d.getStatusCode()+"  "+d.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}}}}else{if(this.sipRegisterState==this.SIP_UNREGISTERING_401_STATE){if(a<200){}else{if(a==200){this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP unregistration failed:"+d.getStatusCode()+"  "+d.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}}}else{if(this.sipRegisterState==this.SIP_UNREGISTERED_STATE){console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}}}}}}}};PrivateJainSipClientConnector.prototype.processSipOptionRequest=function(a){console.debug("PrivateJainSipClientConnector:processSipOptionRequest()");var b=a.getRequest();var c=b.createResponse(200,"OK");c.addHeader(this.jainSipContactHeader);c.removeHeader("P-Asserted-Identity");c.removeHeader("P-Charging-Vector");c.removeHeader("P-Charging-Function-Addresses");c.removeHeader("P-Called-Party-ID");a.getServerTransaction().sendResponse(c)};WebRtcCommCall=function(a){if(a instanceof WebRtcCommClient){console.debug("WebRtcCommCall:WebRtcCommCall()");this.id=undefined;this.webRtcCommClient=a;this.calleePhoneNumber=undefined;this.callerPhoneNumber=undefined;this.configuration=undefined;this.connector=undefined;this.peerConnection=undefined;this.peerConnectionState=undefined;this.remoteMediaStream=undefined;this.remoteSdpOffer=undefined}else{throw"WebRtcCommCall:WebRtcCommCall(): bad arguments"}};WebRtcCommCall.prototype.codecNames={0:"PCMU",8:"PCMA"};WebRtcCommCall.prototype.isOpened=function(){if(this.connector){return this.connector.isOpened()}else{return false}};WebRtcCommCall.prototype.getId=function(){return this.id};WebRtcCommCall.prototype.getCallerPhoneNumber=function(){return this.callerPhoneNumber};WebRtcCommCall.prototype.getConfiguration=function(){return this.configuration};WebRtcCommCall.prototype.getCalleePhoneNumber=function(){return this.calleePhoneNumber};WebRtcCommCall.prototype.getRemoteMediaStream=function(){return this.remoteMediaStream};WebRtcCommCall.prototype.open=function(d,g){console.debug("WebRtcCommCall:open():calleePhoneNumber="+d);console.debug("WebRtcCommCall:open():configuration="+JSON.stringify(g));if(typeof(g)=="object"){if(this.webRtcCommClient.isOpened()){if(this.checkConfiguration(g)){if(this.isOpened()==false){try{this.calleePhoneNumber=d;this.configuration=g;this.connector.open(g);this.createRTCPeerConnection();this.peerConnection.addStream(this.configuration.localMediaStream);var b=this;var c={mandatory:{OfferToReceiveAudio:this.configuration.audioMediaFlag,OfferToReceiveVideo:this.configuration.videoMediaFlag}};if(window.webkitRTCPeerConnection){this.peerConnection.createOffer(function(e){b.processRtcPeerConnectionCreateOfferSuccess(e)},function(e){b.processRtcPeerConnectionCreateOfferError(e)},c)}else{if(window.mozRTCPeerConnection){c.mandatory.MozDontOfferDataChannel=true;this.peerConnection.createOffer(function(e){b.processRtcPeerConnectionCreateOfferSuccess(e)},function(e){b.processRtcPeerConnectionCreateOfferError(e)},c)}}console.debug("WebRtcCommCall:open():mediaContraints="+JSON.stringify(c))}catch(a){console.error("WebRtcCommCall:open(): catched exception:"+a);try{this.close()}catch(f){}throw a}}else{console.error("WebRtcCommCall:open(): bad state, unauthorized action");throw"WebRtcCommCall:open(): bad state, unauthorized action"}}else{console.error("WebRtcCommCall:open(): bad configuration");throw"WebRtcCommCall:open(): bad configuration"}}else{console.error("WebRtcCommCall:open(): bad state, unauthorized action");throw"WebRtcCommCall:open(): bad state, unauthorized action"}}else{console.error("WebRtcCommCall:open(): bad argument, check API documentation");throw"WebRtcCommCall:open(): bad argument, check API documentation"}};WebRtcCommCall.prototype.close=function(){console.debug("WebRtcCommCall:close()");if(this.webRtcCommClient.isOpened()){try{if(this.connector){this.connector.close()}if(this.peerConnection&&this.peerConnection.readyState!="closed"){this.peerConnection.close();this.peerConnection=undefined;var b=this;setTimeout(function(){b.webRtcCommClient.eventListener.onWebRtcCommCallClosedEvent(b)},1)}}catch(a){console.error("WebRtcCommCall:open(): catched exception:"+a)}}else{console.error("WebRtcCommCall:close(): bad state, unauthorized action");throw"WebRtcCommCall:close(): bad state, unauthorized action"}};WebRtcCommCall.prototype.accept=function(f){console.debug("WebRtcCommCall:accept():configuration="+JSON.stringify(f));if(typeof(f)=="object"){if(this.webRtcCommClient.isOpened()){if(this.checkConfiguration(f)){this.configuration=f;if(this.isOpened()==false){try{this.createRTCPeerConnection();this.peerConnection.addStream(this.configuration.localMediaStream);var d=undefined;if(window.webkitRTCPeerConnection){d=new RTCSessionDescription({type:"offer",sdp:this.remoteSdpOffer})}else{if(window.mozRTCPeerConnection){d=new mozRTCSessionDescription({type:"offer",sdp:this.remoteSdpOffer})}}var b=this;this.peerConnectionState="offer-received";this.peerConnection.setRemoteDescription(d,function(){b.processRtcPeerConnectionSetRemoteDescriptionSuccess()},function(e){b.processRtcPeerConnectionSetRemoteDescriptionError(e)})}catch(a){console.error("WebRtcCommCall:accept(): catched exception:"+a);try{this.close()}catch(c){}throw a}}else{console.error("WebRtcCommCall:accept(): bad state, unauthorized action");throw"WebRtcCommCall:accept(): bad state, unauthorized action"}}else{console.error("WebRtcCommCall:accept(): bad configuration");throw"WebRtcCommCall:accept(): bad configuration"}}else{console.error("WebRtcCommCall:accept(): bad state, unauthorized action");throw"WebRtcCommCall:accept(): bad state, unauthorized action"}}else{console.error("WebRtcCommCall:accept(): bad argument, check API documentation");throw"WebRtcCommCall:accept(): bad argument, check API documentation"}};WebRtcCommCall.prototype.reject=function(){console.debug("WebRtcCommCall:reject()");if(this.webRtcCommClient.isOpened()){try{this.connector.reject()}catch(a){console.error("WebRtcCommCall:reject(): catched exception:"+a);try{this.close()}catch(b){}throw a}}else{console.error("WebRtcCommCall:reject(): bad state, unauthorized action");throw"WebRtcCommCall:reject(): bad state, unauthorized action"}};WebRtcCommCall.prototype.checkConfiguration=function(b){console.debug("WebRtcCommCall:checkConfiguration()");var a=true;if(b.localMediaStream==undefined){a=false;console.error("WebRtcCommCall:checkConfiguration(): missing localMediaStream")}if(b.audioMediaFlag==undefined||(typeof(b.audioMediaFlag)!="boolean")){a=false;console.error("WebRtcCommCall:checkConfiguration(): missing audio media flag")}if(b.videoMediaFlag==undefined||(typeof(b.videoMediaFlag)!="boolean")){a=false;console.error("WebRtcCommCall:checkConfiguration(): missing video media flag")}if(b.dataMediaFlag==undefined||(typeof(b.dataMediaFlag)!="boolean")){a=false;console.error("WebRtcCommCall:checkConfiguration(): missing data media flag")}return a};WebRtcCommCall.prototype.createRTCPeerConnection=function(){console.debug("WebRtcCommCall:createPeerConnection()");var b={iceServers:[]};this.peerConnectionState="new";var c=this;if(this.webRtcCommClient.configuration.RTCPeerConnection.stunServer){b={iceServers:[{url:"stun:"+this.webRtcCommClient.configuration.RTCPeerConnection.stunServer}]}}var a={mandatory:{OfferToReceiveAudio:this.configuration.audioMediaFlag,OfferToReceiveVideo:this.configuration.videoMediaFlag}};if(window.webkitRTCPeerConnection){this.peerConnection=new window.webkitRTCPeerConnection(b,a)}else{if(window.mozRTCPeerConnection){this.peerConnection=new window.mozRTCPeerConnection(b,a)}}this.peerConnection.onaddstream=function(d){c.processRtcPeerConnectionOnAddStream(d)};this.peerConnection.onremovestream=function(d){c.onRtcPeerConnectionOnRemoveStreamEvent(d)};this.peerConnection.onstatechange=function(d){c.onRtcPeerConnectionStateChangeEvent(d)};this.peerConnection.onicecandidate=function(d){c.onRtcPeerConnectionIceCandidateEvent(d)};this.peerConnection.ongatheringchange=function(d){c.onRtcPeerConnectionGatheringChangeEvent(d)};this.peerConnection.onicechange=function(d){c.onRtcPeerConnectionIceChangeEvent(d)};if((window.webkitRTCPeerConnection)){this.peerConnection.onopen=function(d){c.onRtcPeerConnectionOnOpenEvent(d)};this.peerConnection.onidentityresult=function(d){c.onRtcPeerConnectionIdentityResultEvent(d)};this.peerConnection.onnegotationneeded=function(d){c.onRtcPeerConnectionIceNegotationNeededEvent(d)}}};WebRtcCommCall.prototype.onPrivateCallConnectorRemoteSdpOfferEvent=function(a){console.debug("WebRtcCommCall:onPrivateCallConnectorSdpOfferEvent()");this.remoteSdpOffer=a};WebRtcCommCall.prototype.onPrivateCallConnectorRemoteSdpAnswerEvent=function(d){console.debug("WebRtcCommCall:onPrivateCallConnectorRemoteSdpAnswerEvent()");try{var c=undefined;if(window.webkitRTCPeerConnection){c=new RTCSessionDescription({type:"answer",sdp:d})}else{if(window.mozRTCPeerConnection){c=new mozRTCSessionDescription({type:"answer",sdp:d})}}var b=this;this.peerConnectionState="answer-received";this.peerConnection.setRemoteDescription(c,function(){b.processRtcPeerConnectionSetRemoteDescriptionSuccess()},function(e){b.processRtcPeerConnectionSetRemoteDescriptionError(e)})}catch(a){console.error("WebRtcCommCall:onPrivateCallConnectorRemoteSdpAnswerEvent(): catched exception:"+a);throw a}};WebRtcCommCall.prototype.onPrivateCallConnectorCallOpenedEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallOpenedEvent()");if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenEvent){var a=this;setTimeout(function(){try{a.webRtcCommClient.eventListener.onWebRtcCommCallOpenEvent(a)}catch(b){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenedEvent(): catched exception in listener:"+b)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallInProgressEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallOpenedEvent()");if(this.webRtcCommClient.eventListener.onWebRtcCommCallInProgressEvent){var a=this;setTimeout(function(){try{a.webRtcCommClient.eventListener.onWebRtcCommCallInProgressEvent(a)}catch(b){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenedEvent(): catched exception in listener:"+b)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallOpenErrorEvent=function(a){console.debug("WebRtcCommCall:onPrivateCallConnectorCallOpenErrorEvent():error="+a);if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenErrorEvent){var b=this;setTimeout(function(){try{b.webRtcCommClient.eventListener.onWebRtcCommCallOpenErrorEvent(b,a)}catch(c){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+c)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallRingingEvent=function(a){console.debug("WebRtcCommCall:onPrivateCallConnectorCallRingingEvent():callerPhoneNumber="+a);if(this.webRtcCommClient.eventListener.onWebRtcCommCallRingingEvent){this.callerPhoneNumber=a;var b=this;setTimeout(function(){try{b.webRtcCommClient.eventListener.onWebRtcCommCallRingingEvent(b)}catch(c){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+c)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallRingingBackEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallRingingBackEvent()");if(this.webRtcCommClient.eventListener.onWebRtcCommCallRingingBackEvent){var a=this;setTimeout(function(){try{a.webRtcCommClient.eventListener.onWebRtcCommCallRingingBackEvent(a)}catch(b){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+b)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallClosedEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallClosedEvent()");this.connector=undefined;try{this.close()}catch(a){}};WebRtcCommCall.prototype.onPrivateCallConnectorCallHangupEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallHangupEvent()");if(this.webRtcCommClient.eventListener.onWebRtcCommCallHangupEvent){var a=this;setTimeout(function(){try{a.webRtcCommClient.eventListener.onWebRtcCommCallHangupEvent(a)}catch(b){console.error("WebRtcCommCall:onPrivateCallConnectorCallHangupEvent(): catched exception in listener:"+b)}},1)}};WebRtcCommCall.prototype.processRtcPeerConnectionError=function(a){console.debug("WebRtcCommCall:processRtcPeerConnectionError(): error="+a);if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenErrorEvent){var c=this;setTimeout(function(){try{c.webRtcCommClient.eventListener.onWebRtcCommCallOpenErrorEvent(c,a)}catch(d){console.error("WebRtcCommCall:processRtcPeerConnectionError(): catched exception in listener:"+d)}},1)}try{this.close()}catch(b){}};WebRtcCommCall.prototype.processRtcPeerConnectionOnAddStream=function(b){try{if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): event="+b);console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): this.peerConnectionState="+this.peerConnectionState);this.remoteMediaStream=b.stream}else{console.warn("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): event ignored")}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): catched exception, exception:"+a);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.onRtcPeerConnectionOnRemoveStreamEvent=function(b){try{if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): event="+b);console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): this.peerConnectionState="+this.peerConnectionState);this.remoteMediaStream=undefined}else{console.warn("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): event ignored")}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): catched exception, exception:"+a);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.onRtcPeerConnectionIceCandidateEvent=function(c){try{if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): rtcIceCandidateEvent="+c);console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate():  this.peerConnectionState="+this.peerConnectionState);if(this.peerConnection.readyState!="closed"){if(c.candidate!=null){console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate: RTCIceCandidateEvent.candidate.candidate="+c.candidate.candidate)}else{console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate: no anymore ICE candidate");if(window.webkitRTCPeerConnection){if(this.peerConnectionState=="preparing-offer"){this.connector.invite(this.peerConnection.localDescription.sdp);this.peerConnectionState="offer-sent"}else{if(this.peerConnectionState=="preparing-answer"){this.connector.accept(this.peerConnection.localDescription.sdp);this.peerConnectionState="established";if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent){var b=this;setTimeout(function(){try{b.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent(b)}catch(d){console.error("WebRtcCommCall:processInvitingSipRequest(): catched exception in listener:"+d)}},1)}}else{if(this.peerConnectionState=="established"){}else{console.error("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): RTCPeerConnection bad state!")}}}}}}else{console.error("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): RTCPeerConnection closed!")}}else{console.warn("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): event ignored")}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): catched exception, exception:"+a);this.processRtcPeerConnectionError(a)}};WebRtcCommCall.prototype.processRtcPeerConnectionCreateOfferSuccess=function(f){try{console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): sdpOffer="+f.sdp);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="new"){var d=this;this.peerConnectionState="preparing-offer";var b=f.sdp;if(this.configuration.audioCodecsFilter||this.configuration.videoCodecsFilter){try{var e=new SDPParser();var a=e.parse(b);this.applyConfiguredCodecFilterOnSessionDescription(a,this.configuration.audioCodecsFilter);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): parsedSdpOffer="+a);f.sdp=a}catch(c){console.error("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): configured codec filtering has failded, use inital RTCPeerConnection SDP offer")}}this.peerConnectionLocalDescription=f;this.peerConnection.setLocalDescription(f,function(){d.processRtcPeerConnectionSetLocalDescriptionSuccess()},function(g){d.processRtcPeerConnectionSetLocalDescriptionError(g)})}else{console.error("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): RTCPeerConnection bad state!")}}catch(c){console.error("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): catched exception, exception:"+c);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionCreateOfferError=function(a){try{if(this.peerConnection){console.error("WebRtcCommCall:processRtcPeerConnectionCreateOfferError():error="+a);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): this.peerConnectionState="+this.peerConnectionState);throw"WebRtcCommCall:processRtcPeerConnectionCreateOfferError():error="+a}else{console.warn("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): event ignored")}}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): catched exception, exception:"+b);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionSetLocalDescriptionSuccess=function(){try{if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess()");console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): this.peerConnectionState="+this.peerConnectionState);if(window.mozRTCPeerConnection){if(this.peerConnectionState=="preparing-offer"){this.connector.invite(this.peerConnection.localDescription.sdp);this.peerConnectionState="offer-sent"}else{if(this.peerConnectionState=="preparing-answer"){this.connector.accept(this.peerConnection.localDescription.sdp);this.peerConnectionState="established";if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent){var b=this;setTimeout(function(){try{b.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent(b)}catch(c){console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): catched exception in listener:"+c)}},1)}}else{if(this.peerConnectionState=="established"){}else{console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): RTCPeerConnection bad state!")}}}}}else{console.warn("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): event ignored")}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): catched exception, exception:"+a);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionSetLocalDescriptionError=function(a){try{if(this.peerConnection){console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError():error="+a);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): this.peerConnectionState="+this.peerConnectionState);throw"WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError():error="+a}else{console.warn("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): event ignored")}}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): catched exception, exception:"+b);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionCreateAnswerSuccess=function(c){try{if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess():answer.sdp="+c.sdp);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="offer-received"){var b=this;this.peerConnectionState="preparing-answer";this.peerConnectionLocalDescription=c;this.peerConnection.setLocalDescription(c,function(){b.processRtcPeerConnectionSetLocalDescriptionSuccess()},function(d){b.processRtcPeerConnectionSetLocalDescriptionError(d)})}else{console.error("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): RTCPeerConnection bad state!")}}else{console.warn("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): event ignored")}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): catched exception, exception:"+a);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionCreateAnswerError=function(a){console.error("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError():error="+a);try{if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): event ignored")}}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): catched exception, exception:"+b);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionSetRemoteDescriptionSuccess=function(){try{if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="answer-received"){this.peerConnectionState="established";if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent){var b=this;setTimeout(function(){try{b.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent(b)}catch(c){console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): catched exception in listener:"+c)}},1)}}else{if(this.peerConnectionState=="offer-received"){var b=this;if(window.webkitRTCPeerConnection){this.peerConnection.createAnswer(function(c){b.processRtcPeerConnectionCreateAnswerSuccess(c)},function(c){b.processRtcPeerConnectionCreateAnswerError(c)})}else{if(window.mozRTCPeerConnection){this.peerConnection.createAnswer(function(c){b.processRtcPeerConnectionCreateAnswerSuccess(c)},function(c){b.processRtcPeerConnectionCreateAnswerError(c)},{mandatory:{MozDontOfferDataChannel:true}})}}}else{console.error("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): RTCPeerConnection bad state!")}}}else{console.warn("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): event ignored")}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): catched exception, exception:"+a);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionSetRemoteDescriptionError=function(a){try{if(this.peerConnection){console.error("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError():error="+a);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): this.peerConnectionState="+this.peerConnectionState);throw"WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError():error="+a}else{console.warn("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): event ignored")}}catch(b){this.processRtcPeerConnectionError(a)}};WebRtcCommCall.prototype.onRtcPeerConnectionOnOpenEvent=function(a){console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen(): event="+a);if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen():this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRtcCommCall:processRtcPeerConnectionOnOpen(): event ignored")}};WebRtcCommCall.prototype.onRtcPeerConnectionStateChangeEvent=function(a){console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): event="+a);if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnection&&this.peerConnection.readyState=="closed"){this.peerConnection=null}}else{console.warn("WebRtcCommCall:processRtcPeerConnectionStateChange(): event ignored")}};WebRtcCommCall.prototype.onRtcPeerConnectionIceNegotationNeededEvent=function(a){console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded():event="+a);if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded(): event ignored")}};WebRtcCommCall.prototype.onRtcPeerConnectionGatheringChangeEvent=function(a){console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange():event="+a);if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange(): peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange(): peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange(): peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRtcCommCall:processRtcPeerConnectionGatheringChange(): event ignored")}};WebRtcCommCall.prototype.onRtcPeerConnectionIceChangeEvent=function(a){console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange():event="+a);if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange(): peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange(): peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange(): peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRtcCommCall:processRtcPeerConnectionIceChange(): event ignored")}};WebRtcCommCall.prototype.onRtcPeerConnectionIdentityResultEvent=function(a){console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult():event="+a);if(this.peerConnection){console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult(): peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult(): peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult(): peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult(): this.peerConnectionState="+this.peerConnectionState)}else{console.warn("WebRtcCommCall:processRtcPeerConnectionIdentityResult(): event ignored")}};WebRtcCommCall.prototype.applyConfiguredCodecFilterOnSessionDescription=function(f){if(f instanceof SessionDescription){try{console.debug("WebRtcCommCall:applyConfiguredCodecFilterOnSessionDescription(): sessionDescription="+f);var g=f.getMediaDescriptions(false);for(var e=0;e<g.length;e++){var a=g[e];var h=a.getMedia();var l=h.getType();if(l=="audio"&&this.configuration.audioCodecsFilter){var k=this.getOfferedCodecsInMediaDescription(a);var j=(this.configuration.audioCodecsFilter).split(",");this.applyCodecFiltersOnOfferedCodecs(k,j);this.updateMediaDescription(a,k,j)}else{if(l=="video"&&this.configuration.videoCodecsFilter){var b=this.getOfferedCodecsInMediaDescription(a);var d=(this.configuration.videoCodecsFilter).split(",");this.applyCodecFiltersOnOfferedCodecs(b,d);this.updateMediaDescription(a,b,d)}}}}catch(c){console.error("WebRtcCommCall:applyConfiguredCodecFilterOnSessionDescription(): catched exception, exception:"+c);throw c}}else{throw"WebRtcCommCall:applyConfiguredCodecFilterOnSessionDescription(): bad arguments"}};WebRtcCommCall.prototype.getOfferedCodecsInMediaDescription=function(a){if(a instanceof MediaDescription){var i=a.getMedia().getFormats(false);var f={};for(var h=0;h<i.length;h++){var o=i[h];console.debug("WebRtcCommCall:getOfferedCodecsInMediaDescription(): payloadType="+o);console.debug("WebRtcCommCall:getOfferedCodecsInMediaDescription(): this.codecNames[payloadType]="+this.codecNames[o]);f[o]=this.codecNames[o]}var e=a.getAttributes();for(var g=0;g<e.length;g++){var l=e[g];console.debug("WebRtcCommCall:getOfferedCodecsInMediaDescription(): attributField.getName()="+l.getName());if(l.getName()=="rtpmap"){try{var d=l.getValue();var n=d.split(" ");var o=n[0];var b=n[1];var m=b.split("/");var p=m[0];f[o]=p.toUpperCase();console.debug("WebRtcCommCall:getOfferedCodecsInMediaDescription(): payloadType="+o);console.debug("WebRtcCommCall:getOfferedCodecsInMediaDescription(): codecName="+p)}catch(c){console.error("WebRtcCommCall:getOfferedCodecsInMediaDescription(): rtpmap format not supported")}}}return f}else{throw"WebRtcCommCall:getOfferedCodecsInMediaDescription(): bad arguments"}};WebRtcCommCall.prototype.applyCodecFiltersOnOfferedCodecs=function(e,d){if(typeof(e)=="object"&&d instanceof Array){for(var b in e){var a=false;for(var c=0;c<d.length;c++){if(e[b]==d[c]){a=true;break}}if(a==false){delete (e[b])}}}else{throw"WebRtcCommCall:applyCodecFiltersOnOfferedCodecs(): bad arguments"}};WebRtcCommCall.prototype.updateMediaDescription=function(a,n,h){if(a instanceof MediaDescription&&typeof(n)=="object"&&h instanceof Array){var f=new Array();for(var l=0;l<h.length;l++){for(var j in n){if(n[j]==h[l]){f.push(j);break}}}a.getMedia().setFormats(f);var b=new Array();var e=a.getAttributes();for(var g=0;g<e.length;g++){var m=e[g];console.debug("WebRtcCommCall:updateMediaDescription(): attributField.getName()="+m.getName());if(m.getName()=="rtpmap"){try{var d=m.getValue();var p=d.split(" ");var o=p[0];if(n[o]!=undefined){b.push(m)}}catch(c){console.error("WebRtcCommCall:updateMediaDescription(): rtpmap format not supported")}}else{b.push(m)}}a.setAttributes(b)}else{throw"WebRtcCommCall:updateMediaDescription(): bad arguments"}};WebRtcCommClient=function(a){if(typeof a=="object"){this.id="WebRtcCommClient"+Math.floor(Math.random()*2147483648);console.debug("WebRtcCommClient:WebRtcCommClient():this.id="+this.id);this.eventListener=a;this.configuration=undefined;this.connector=undefined;this.closePendingFlag=false}else{throw"WebRtcCommClient:WebRtcCommClient(): bad arguments"}};WebRtcCommClient.prototype.SIP="SIP";WebRtcCommClient.prototype.isOpened=function(){if(this.connector){return this.connector.isOpened()}else{return false}};WebRtcCommClient.prototype.getConfiguration=function(){return this.configuration};WebRtcCommClient.prototype.open=function(a){console.debug("WebRtcCommClient:open(): configuration="+JSON.stringify(a));if(typeof(a)=="object"){if(this.isOpened()==false){if(this.checkConfiguration(a)==true){this.configuration=a;if(a.communicationMode==WebRtcCommClient.prototype.SIP){this.connector=new PrivateJainSipClientConnector(this);this.connector.open(this.configuration.sip)}}else{console.error("WebRtcCommClient:open(): bad configuration");throw"WebRtcCommClient:open(): bad configuration"}}else{console.error("WebRtcCommClient:open(): bad state, unauthorized action");throw"WebRtcCommClient:open(): bad state, unauthorized action"}}else{console.error("WebRtcCommClient:open(): bad argument, check API documentation");throw"WebRtcCommClient:open(): bad argument, check API documentation"}};WebRtcCommClient.prototype.close=function(){console.debug("WebRtcCommClient:close()");if(this.isOpened()){try{this.closePendingFlag=true;this.connector.close()}catch(a){console.error("WebRtcCommClient:close(): catched exception:"+a);this.closePendingFlag=false;this.connector=undefined;if(this.eventListener.onWebRtcCommClientClosedEvent!=undefined){var b=this;setTimeout(function(){try{b.eventListener.onWebRtcCommClientClosedEvent(b)}catch(c){console.error("WebRtcCommClient:onWebRtcCommClientClosed(): catched exception in event listener:"+c)}},1)}}}};WebRtcCommClient.prototype.call=function(c,d){console.debug("WebRtcCommClient:call():calleePhoneNumber="+c);console.debug("WebRtcCommClient:call():callConfiguration="+JSON.stringify(d));try{if(typeof(c)=="string"&&typeof(d)=="object"){if(this.isOpened()){var a=new WebRtcCommCall(this);a.connector=this.connector.createPrivateCallConnector(a);a.id=a.connector.getId();a.open(c,d);return a}else{console.error("WebRtcCommClient:call(): bad state, unauthorized action");throw"WebRtcCommClient:call(): bad state, unauthorized action"}}else{console.error("WebRtcCommClient:call(): bad argument, check API documentation");throw"WebRtcCommClient:call(): bad argument, check API documentation"}}catch(b){console.error("WebRtcCommClient:call(): catched exception:"+b);throw b}};WebRtcCommClient.prototype.checkConfiguration=function(b){console.debug("WebRtcCommClient:checkConfiguration(): configuration="+JSON.stringify(b));var a=true;if(b.communicationMode!=undefined){if(b.communicationMode==WebRtcCommClient.prototype.SIP){}else{a=false;console.error("WebRtcCommClient:checkConfiguration(): unsupported communicationMode")}}else{a=false;console.error("WebRtcCommClient:checkConfiguration(): missing configuration parameter communicationMode")}return a};WebRtcCommClient.prototype.onPrivateClientConnectorOpenedEvent=function(){console.debug("WebRtcCommClient:onPrivateClientConnectorOpenedEvent()");if(this.eventListener.onWebRtcCommClientOpenedEvent!=undefined){var a=this;setTimeout(function(){try{a.eventListener.onWebRtcCommClientOpenedEvent()}catch(b){console.error("WebRtcCommClient:onPrivateClientConnectorOpenedEvent(): catched exception in event listener:"+b)}},1)}};WebRtcCommClient.prototype.onPrivateClientConnectorOpenErrorEvent=function(a){console.debug("WebRtcCommClient:onPrivateClientConnectorOpenErrorEvent():error:"+a);try{this.close()}catch(b){}if(this.eventListener.onWebRtcCommClientOpenErrorEvent!=undefined){var c=this;setTimeout(function(){try{c.eventListener.onWebRtcCommClientOpenErrorEvent(a)}catch(d){console.error("WebRtcCommClient:onPrivateClientConnectorOpenErrorEvent(): catched exception in event listener:"+d)}},1)}};WebRtcCommClient.prototype.onPrivateClientConnectorClosedEvent=function(){console.debug("WebRtcCommClient:onPrivateClientConnectorClosedEvent()");var c=this.isOpened()||this.closePendingFlag;try{if(this.closePendingFlag==false){this.close()}else{this.connector=undefined}}catch(a){}if(c&&this.eventListener.onWebRtcCommClientClosedEvent!=undefined){var b=this;setTimeout(function(){try{b.eventListener.onWebRtcCommClientClosedEvent()}catch(d){console.error("WebRtcCommClient:onPrivateClientConnectorClosedEvent(): catched exception in event listener:"+d)}},1)}else{if(!c&&this.eventListener.onWebRtcCommClientOpenErrorEvent!=undefined){var b=this;setTimeout(function(){try{b.eventListener.onWebRtcCommClientOpenErrorEvent("Connection to WebRtcCommServer has failed")}catch(d){console.error("WebRtcCommClient:onWebRtcCommClientOpenErrorEvent(): catched exception in event listener:"+d)}},1)}}};