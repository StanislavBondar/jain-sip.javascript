PrivateJainSipCallConnector=function(b,a){if(b instanceof WebRtcCommCall){if(typeof(a)=="string"){this.sipCallId=a}else{this.sipCallId=new String(new Date().getTime())}this.webRtcCommCall=b;this.webRtcCommCall.id=this.sipCallId;this.configuration=undefined;this.resetSipContext()}else{throw"PrivateJainSipCallConnector:PrivateJainSipCallConnector(): bad arguments"}};PrivateJainSipCallConnector.prototype.SIP_INVITING_INITIAL_STATE="INVITING_INITIAL_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_STATE="INVITING_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_407_STATE="INVITING_407_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_ACCEPTED_STATE="INVITING_ACCEPTED_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_LOCAL_HANGINGUP_STATE="INVITING_LOCAL_HANGINGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_LOCAL_HANGINGUP_407_STATE="INVITING_LOCAL_HANGINGUP_407_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_CANCELLING_STATE="INVITING_CANCELLING_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_ERROR_STATE="INVITING_ERROR_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_HANGUP_STATE="INVITING_HANGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITING_CANCELLED_STATE="SIP_INVITING_CANCELLED_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_INITIAL_STATE="INVITED_INITIAL_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_ACCEPTED_STATE="INVITED_ACCEPTED_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_LOCAL_HANGINGUP_STATE="INVITED_LOCAL_HANGINGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_LOCAL_HANGINGUP_407_STATE="INVITED_LOCAL_HANGINGUP_407_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_HANGUP_STATE="INVITED_HANGUP_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_ERROR_STATE="INVITED_ERROR_STATE";PrivateJainSipCallConnector.prototype.SIP_INVITED_CANCELLED_STATE="INVITING_HANGUP_STATE";PrivateJainSipCallConnector.prototype.isOpened=function(){return((this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE)||(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE))};PrivateJainSipCallConnector.prototype.getId=function(){return this.sipCallId};PrivateJainSipCallConnector.prototype.open=function(a){console.debug("PrivateJainSipCallConnector:open()");if(this.sipCallState==undefined){if(typeof(a)=="object"){if(this.checkConfiguration(a)==true){this.sipCallState=this.SIP_INVITING_INITIAL_STATE;this.configuration=a}else{console.error("PrivateJainSipCallConnector:open(): bad configuration");throw"PrivateJainSipCallConnector:open(): bad configuration"}}else{this.sipCallState=SIP_INVITED_INITIAL_STATE}}else{console.error("PrivateJainSipCallConnector:open(): bad state, unauthorized action");throw"PrivateJainSipCallConnector:open(): bad state, unauthorized action"}};PrivateJainSipCallConnector.prototype.close=function(){console.debug("PrivateJainSipCallConnector:close(): this.sipCallState="+this.sipCallState);if(this.sipCallState!=undefined){try{if(this.sipCallState==this.SIP_INITIAL_INVITING_STATE){this.resetSipContext();this.webRtcCommCall.webRtcCommClient.connector.removeCallConnector(this.sipCallId);this.webRtcCommCall.onPrivateCallConnectorCallClosedEvent()}else{if(this.sipCallState==this.SIP_INVITING_STATE||this.sipCallState==this.SIP_INVITING_407_STATE){this.jainSipInvitingCancelRequest=this.jainSipInvitingTransaction.createCancel();this.jainSipInvitingCancelRequest.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);this.jainSipInvitingCancelRequest.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);this.jainSipInvitingCancelTransaction=this.webRtcCommCall.webRtcCommClient.connector.sipProvider.getNewClientTransaction(this.jainSipInvitingCancelRequest);this.jainSipInvitingCancelTransaction.sendRequest();this.sipCallState=this.SIP_INVITING_CANCELLING_STATE}else{if(this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE){var c=this.jainSipInvitingRequest.createBYERequest(true);c.removeHeader("Contact");c.removeHeader("User-Agent");c.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);c.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);var a=this.webRtcCommCall.webRtcCommClient.connector.sipProvider.getNewClientTransaction(c);this.jainSipInvitingDialog.sendRequest(a);this.sipCallState=this.SIP_INVITING_LOCAL_HANGINGUP_STATE;this.webRtcCommCall.onPrivateCallConnectorCallClosedEvent()}else{if(this.sipCallState==this.SIP_INVITED_INITIAL_STATE){var d=this.jainSipInvitedRequest.createResponse(480,"Temporarily Unavailable");d.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);d.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendResponse(d);this.resetSipContext();this.webRtcCommCall.webRtcCommClient.connector.removeCallConnector(this.sipCallId)}else{if(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE){var c=this.jainSipInvitedRequest.createBYERequest(true);c.removeHeader("Contact");c.removeHeader("User-Agent");c.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);c.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);var a=this.webRtcCommCall.webRtcCommClient.connector.sipProvider.getNewClientTransaction(c);this.jainSipInvitedDialog.sendRequest(a);this.sipCallState=this.SIP_INVITED_LOCAL_HANGINGUP_STATE}else{this.resetSipContext();this.webRtcCommCall.webRtcCommClient.connector.removeCallConnector(this.sipCallId);this.webRtcCommCall.onPrivateCallConnectorCallClosedEvent()}}}}}}catch(b){console.error("PrivateJainSipCallConnector:byeCall(): catched exception:"+b);this.resetSipContext();this.webRtcCommCall.webRtcCommClient.connector.removeCallConnector(this.sipCallId);this.webRtcCommCall.onPrivateCallConnectorCallClosedEvent()}}};PrivateJainSipCallConnector.prototype.reject=function(){console.debug("PrivateJainSipCallConnector:reject()");if(this.sipCallState==this.SIP_INVITED_INITIAL_STATE){try{var a=this.jainSipInvitedRequest.createResponse(486,"Busy here");a.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);a.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendResponse(a)}catch(b){console.error("PrivateJainSipCallConnector:reject(): catched exception:"+b)}this.close()}else{console.error("PrivateJainSipCallConnector:reject(): bad state, unauthorized action");throw"PrivateJainSipCallConnector:reject(): bad state, unauthorized action"}};PrivateJainSipCallConnector.prototype.checkConfiguration=function(b){console.debug("PrivateJainSipCallConnector:checkConfiguration()");var a=true;return a};PrivateJainSipCallConnector.prototype.resetSipContext=function(){console.debug("PrivateJainSipCallConnector:resetSipContext()");this.sipCallState=undefined;this.jainSipInvitingSentRequest=undefined;this.jainSipInvitingDialog=undefined;this.jainSipInvitingTransaction=undefined;this.jainSipInvitedReceivedRequest=undefined;this.jainSipInvitedDialog=undefined;this.jainSipInvitedTransaction=undefined};PrivateJainSipCallConnector.prototype.invite=function(l){console.debug("PrivateJainSipCallConnector:invite()");var a=this.webRtcCommCall.webRtcCommClient.connector.configuration.sipUserName+"@"+this.webRtcCommCall.webRtcCommClient.connector.configuration.sipDomain;var m=this.webRtcCommCall.calleePhoneNumber+"@"+this.webRtcCommCall.webRtcCommClient.connector.configuration.sipDomain;var e=new Date();var n=this.webRtcCommCall.webRtcCommClient.connector.headerFactory.createCSeqHeader(1,"INVITE");var q=this.webRtcCommCall.webRtcCommClient.connector.headerFactory.createCallIdHeader(this.sipCallId);var h=this.webRtcCommCall.webRtcCommClient.connector.headerFactory.createMaxForwardsHeader(70);var d=this.webRtcCommCall.webRtcCommClient.connector.addressFactory.createSipURI_user_host(null,m);var k=this.webRtcCommCall.webRtcCommClient.connector.headerFactory.createHeaders("Allow: INVITE,ACK,CANCEL,BYE");var b=this.webRtcCommCall.webRtcCommClient.connector.addressFactory.createSipURI_user_host(null,a);var g=this.webRtcCommCall.webRtcCommClient.connector.addressFactory.createAddress_name_uri(null,b);var j=e.getTime();var i=this.webRtcCommCall.webRtcCommClient.connector.headerFactory.createFromHeader(g,j);var o=this.webRtcCommCall.webRtcCommClient.connector.addressFactory.createSipURI_user_host(null,m);var c=this.webRtcCommCall.webRtcCommClient.connector.addressFactory.createAddress_name_uri(null,o);var f=this.webRtcCommCall.webRtcCommClient.connector.headerFactory.createToHeader(c,null);var p=this.webRtcCommCall.webRtcCommClient.connector.headerFactory.createContentTypeHeader("application","sdp");this.jainSipInvitingRequest=this.webRtcCommCall.webRtcCommClient.connector.messageFactory.createRequest(d,"INVITE",q,n,i,f,h,p,l);this.webRtcCommCall.webRtcCommClient.connector.messageFactory.addHeader(this.jainSipInvitingRequest,this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);this.webRtcCommCall.webRtcCommClient.connector.messageFactory.addHeader(this.jainSipInvitingRequest,k);this.webRtcCommCall.webRtcCommClient.connector.messageFactory.addHeader(this.jainSipInvitingRequest,this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);this.sipCallState=this.SIP_INVITING_STATE;this.jainSipInvitingTransaction=this.webRtcCommCall.webRtcCommClient.connector.sipProvider.getNewClientTransaction(this.jainSipInvitingRequest);this.jainSipInvitingRequest.setTransaction(this.jainSipInvitingTransaction);this.jainSipInvitingDialog=this.jainSipInvitingTransaction.getDialog();this.jainSipInvitingTransaction.sendRequest();this.sipCallState=this.SIP_INVITING_STATE};PrivateJainSipCallConnector.prototype.accept=function(a){console.debug("PrivateJainSipCallConnector:accept()");var b=this.jainSipInvitedRequest.createResponse(200,"OK");b.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);b.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);b.setMessageContent("application","sdp",a);this.jainSipInvitedTransaction.sendResponse(b);this.sipCallState=this.SIP_INVITED_ACCEPTED_STATE};PrivateJainSipCallConnector.prototype.onJainSipClientConnectorSipRequestEvent=function(a){console.debug("PrivateJainSipCallConnector:onJainSipClientConnectorSipRequestEvent()");if(this.jainSipInvitingDialog!=undefined){this.processInvitingSipRequestEvent(a)}else{if(this.jainSipInvitedDialog!=undefined){this.processInvitedSipRequestEvent(a)}else{this.processInvitedSipRequestEvent(a)}}};PrivateJainSipCallConnector.prototype.onJainSipClientConnectorSipResponseEvent=function(a){console.debug("PrivateJainSipCallConnector:onJainSipClientConnectorSipResponseEvent()");if(this.jainSipInvitingDialog!=undefined){this.processInvitingSipResponseEvent(a)}else{if(this.jainSipInvitedDialog!=undefined){this.processInvitedSipResponseEvent(a)}else{console.warn("PrivateJainSipCallConnector:onJainSipClientConnectorSipResponseEvent(): response ignored")}}};PrivateJainSipCallConnector.prototype.onJainSipClientConnectorSipTimeoutEvent=function(a){console.debug("PrivateJainSipCallConnector:onJainSipClientConnectorSipTimeoutEvent()");this.close()};PrivateJainSipCallConnector.prototype.processInvitingSipRequestEvent=function(a){console.debug("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): this.sipCallState="+this.sipCallState);var c=a.getRequest();var d=c.getMethod();if(this.sipCallState==this.SIP_INVITING_INITIAL_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_407_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_FAILED_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE){if(d=="BYE"){try{var e=c.createResponse(200,"OK");e.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);a.getServerTransaction().sendResponse(e);this.sipCallState=this.SIP_INVITING_HANGUP_STATE}catch(b){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception exception:"+b)}this.webRtcCommCall.onPrivateCallConnectorCallHangupEvent();this.close()}else{console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}}else{console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): bad state, SIP request ignored")}}}}}};PrivateJainSipCallConnector.prototype.processInvitingSipResponseEvent=function(b){console.debug("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): this.sipCallState="+this.sipCallState);var h=b.getResponse();var d=parseInt(h.getStatusCode());if(this.sipCallState==this.SIP_INVITING_STATE){if(d<200){if(d==180){this.webRtcCommCall.onPrivateCallConnectorCallRingingBackEvent()}else{if(d==183){this.webRtcCommCall.onPrivateCallConnectorCallInProgressEvent()}}console.debug("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): 1XX response ignored")}else{if(d==407){var e=new Number(this.jainSipInvitingRequest.getCSeq().getSeqNumber());this.jainSipInvitingRequest.getCSeq().setSeqNumber(e+1);var j=this.webRtcCommCall.webRtcCommClient.connector.headerFactory.createAuthorizationHeader(h,this.jainSipInvitingRequest,this.configuration.sipPassword,this.configuration.sipLogin);this.webRtcCommCall.webRtcCommClient.connector.messageFactory.addHeader(this.jainSipInvitingRequest,j);this.jainSipInvitingRequest=this.webRtcCommCall.webRtcCommClient.connector.messageFactory.setNewViaHeader(this.jainSipInvitingRequest);this.jainSipInvitingTransaction=this.webRtcCommCall.webRtcCommClient.connector.sipProvider.getNewClientTransaction(this.jainSipInvitingRequest);this.jainSipInvitingRequest.setTransaction(this.jainSipInvitingTransaction);this.jainSipInvitingTransaction.sendRequest();this.sipCallState=this.SIP_INVITING_407_STATE}else{if(d==200){this.jainSipInvitingDialog=b.getOriginalTransaction().getDialog();try{this.jainSipInvitingDialog.setRemoteTarget(h.getHeader("Contact"));var f=this.jainSipInvitingTransaction.createAck();f.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);f.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);this.jainSipInvitingDialog.sendAck(f);this.sipCallState=this.SIP_INVITING_ACCEPTED_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c)}try{var g=h.getContent();this.webRtcCommCall.onPrivateCallConnectorRemoteSdpAnswerEvent(g)}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c);this.webRtcCommCall.onPrivateCallConnectorCallOpenErrorEvent(c);this.close()}}else{console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): SIP INVITE failed:"+h.getStatusCode()+"  "+h.getStatusLine().toString());this.sipCallState=this.SIP_INVITING_ERROR_STATE;this.webRtcCommCall.onPrivateCallConnectorCallOpenErrorEvent(h.getStatusLine().getReasonPhrase());this.close()}}}}else{if(this.sipCallState==this.SIP_INVITING_CANCELLING_STATE){this.sipCallState=this.SIP_INVITING_CANCELLED_STATE;this.close()}else{if(this.sipCallState==this.SIP_INVITING_407_STATE){if(d<200){console.debug("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): 1XX response ignored")}else{if(d==200){this.jainSipInvitingDialog=b.getOriginalTransaction().getDialog();try{this.jainSipInvitingDialog.setRemoteTarget(h.getHeader("Contact"));var f=this.jainSipInvitingTransaction.createAck();f.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);f.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);this.jainSipInvitingDialog.sendAck(f);this.sipCallState=this.SIP_INVITING_ACCEPTED_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c)}try{var g=h.getContent();this.webRtcCommCall.onPrivateCallConnectorRemoteSdpAnswerEvent(g)}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c);this.webRtcCommCall.onPrivateCallConnectorCallOpenErrorEvent(c);this.close()}}else{this.sipCallState=this.SIP_INVITING_ERROR_STATE;this.webRtcCommCall.onPrivateCallConnectorCallOpenErrorEvent(h.getStatusLine().getReasonPhrase());this.close()}}}else{if(this.sipCallState==this.SIP_INVITING_FAILED_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITING_ACCEPTED_STATE){console.error("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITING_LOCAL_HANGINGUP_STATE){if(d==407){try{var a=this.jainSipInvitingDialog.createRequest("BYE");var i=this.webRtcCommCall.webRtcCommClient.connector.sipProvider.getNewClientTransaction(a);var j=this.webRtcCommCall.webRtcCommClient.connector.headerFactory.createAuthorizationHeader(h,a,this.configuration.sipPassword,this.configuration.sipLogin);this.webRtcCommCall.webRtcCommClient.connector.messageFactory.addHeader(a,j);this.jainSipInvitingDialog.sendRequest(i);this.sipCallState=this.SIP_INVITING_HANGINGUP_407_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitingSipRequestEvent(): catched exception, exception:"+c);this.close()}}else{this.close()}}else{if(this.sipCallState==this.SIP_INVITING_LOCAL_HANGINGUP_407_STATE){this.close()}else{console.error("PrivateJainSipCallConnector:processInvitingSipResponseEvent(): bad state, SIP response ignored")}}}}}}}};PrivateJainSipCallConnector.prototype.processInvitedSipRequestEvent=function(c){console.debug("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): this.sipCallState="+this.sipCallState);var a=c.getRequest();var e=a.getMethod();var d=a.getHeader("From");if(this.sipCallState==this.SIP_INVITED_INITIAL_STATE){if(e=="INVITE"){try{this.jainSipInvitedRequest=a;this.jainSipInvitedTransaction=c.getServerTransaction();this.jainSipInvitedDialog=c.getServerTransaction().getDialog();var j=a.createResponse(180,"Ringing");j.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);j.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);c.getServerTransaction().sendResponse(j)}catch(b){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): catched exception, exception:"+b)}this.webRtcCommCall.onPrivateCallConnectorRemoteSdpOfferEvent(this.jainSipInvitedRequest.getContent());var f=this;var i=d.getAddress().getURI().getUser();this.webRtcCommCall.onPrivateCallConnectorCallRingingEvent(i)}else{if(e=="CANCEL"){try{var g=a.createResponse(200,"OK");g.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);g.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);c.getServerTransaction().sendResponse(g);var h=this.jainSipInvitedRequest.createResponse(487,"(Request Cancelled)");h.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);this.jainSipInvitedTransaction.sendMessage(h);this.sipCallState=this.SIP_INVITED_CANCELLED_STATE}catch(b){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): catched exception, exception:"+b)}this.webRtcCommCall.onPrivateCallConnectorCallHangupEvent();this.close()}else{console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}}}else{if(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE){if(e=="BYE"){try{var g=a.createResponse(200,"OK");g.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);g.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);c.getServerTransaction().sendResponse(g);this.sipCallState=this.SIP_INVITED_HANGUP_STATE}catch(b){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): catched exception exception:"+b)}this.webRtcCommCall.onPrivateCallConnectorCallHangupEvent();this.close()}else{if(e=="ACK"){this.jainSipInvitedDialog=c.getServerTransaction().getDialog()}else{console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}}}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_407_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipRequestEvent(): bad state, SIP request ignored")}}}}};PrivateJainSipCallConnector.prototype.processInvitedSipResponseEvent=function(f){console.debug("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): this.invitingState="+this.invitingState);var g=f.getResponse();var e=parseInt(g.getStatusCode());if(this.sipCallState==this.SIP_INVITED_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITED_ACCEPTED_STATE){console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): bad state, SIP response ignored")}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_STATE){if(e==407){try{var d=this.jainSipInvitedDialog.createRequest("BYE");var a=this.sipProvider.getNewClientTransaction(d);var b=this.headerFactory.createAuthorizationHeader(g,d,this.configuration.sipPassword,this.configuration.sipLogin);this.messageFactory.addHeader(d,b);d.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipContactHeader);d.addHeader(this.webRtcCommCall.webRtcCommClient.connector.jainSipUserAgentHeader);this.jainSipInvitedDialog.sendRequest(a);this.sipCallState=this.SIP_INVITED_HANGINGUP_407_STATE}catch(c){console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): catched exception, exception:"+c);this.close()}}else{this.close()}}else{if(this.sipCallState==this.SIP_INVITED_LOCAL_HANGINGUP_407_STATE){this.close()}else{console.error("PrivateJainSipCallConnector:processInvitedSipResponseEvent(): bad state, SIP request ignored")}}}}};PrivateJainSipClientConnector=function(a){console.debug("PrivateJainSipClientConnector:PrivateJainSipClientConnector()");if(a instanceof WebRtcCommClient){this.webRtcCommClient=a;this.reset()}else{throw"PrivateJainSipClientConnector:PrivateJainSipClientConnector(): bad arguments"}};PrivateJainSipClientConnector.prototype.SIP_ALLOW_HEADER="Allow: INVITE,ACK,CANCEL,BYE, OPTIONS";PrivateJainSipClientConnector.prototype.SIP_UNREGISTERED_STATE="SIP_UNREGISTERED_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTERING_STATE="SIP_REGISTERING_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTER_REFRESHING_STATE="SIP_REGISTER_REFRESHING_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTERING_401_STATE="SIP_REGISTERING_401_STATE";PrivateJainSipClientConnector.prototype.SIP_REGISTERED_STATE="SIP_REGISTERED_STATE";PrivateJainSipClientConnector.prototype.SIP_UNREGISTERING_401_STATE="SIP_UNREGISTERING_401_STATE";PrivateJainSipClientConnector.prototype.SIP_UNREGISTERING_STATE="SIP_UNREGISTERING_STATE";PrivateJainSipClientConnector.prototype.isOpened=function(){return this.openedFlag};PrivateJainSipClientConnector.prototype.open=function(b){console.debug("PrivateJainSipClientConnector:open()");try{if(typeof(b)=="object"){if(this.openedFlag==false){if(this.checkConfiguration(b)==true){this.configuration=b;this.sipFactory=new SipFactory();this.sipStack=this.sipFactory.createSipStack(this.configuration.sipOutboundProxy,this.configuration.sipUserAgent);this.listeningPoint=this.sipStack.createListeningPoint();this.sipProvider=this.sipStack.createSipProvider(this.listeningPoint);this.sipProvider.addSipListener(this);this.headerFactory=this.sipFactory.createHeaderFactory();this.addressFactory=this.sipFactory.createAddressFactory();this.messageFactory=this.sipFactory.createMessageFactory(this.listeningPoint);this.jainSipContactHeader=this.listeningPoint.createContactHeader(this.configuration.sipUserName);if((this.configuration.sipApplicationProfile!=undefined)&&(this.configuration.sipApplicationProfile.length!=0)){this.jainSipContactHeader.setParameter(this.configuration.sipApplicationProfile,null)}this.jainSipUserAgentHeader=this.headerFactory.createUserAgentHeader(this.listeningPoint.getUserAgent());this.sipStack.start()}else{console.error("PrivateJainSipClientConnector:open(): bad configuration");throw"PrivateJainSipClientConnector:open(): bad configuration"}}else{console.error("PrivateJainSipClientConnector:open(): bad state, unauthorized action");throw"PrivateJainSipClientConnector:open(): bad state, unauthorized action"}}else{console.error("PrivateJainSipClientConnector:open(): bad argument, check API documentation");throw"PrivateJainSipClientConnector:open(): bad argument, check API documentation"}}catch(a){this.reset();console.error("PrivateJainSipClientConnector:open(): catched exception:"+a);throw a}};PrivateJainSipClientConnector.prototype.close=function(){console.debug("PrivateJainSipClientConnector:close()");try{if(this.openedFlag==true){for(var b in this.callConnectors){var d=this.findCallConnector(b);if(d.isOpened()){d.close()}}if(this.configuration.sipRegisterMode==true){if(this.sipRegisterState==this.SIP_REGISTERED_STATE){this.sipUnregisterPendingFlag=false;this.sipRegisterState=this.SIP_UNREGISTERING_STATE;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}var a=new Number(this.jainSipRegisterSentRequest.getCSeq().getSeqNumber());this.jainSipRegisterSentRequest.getCSeq().setSeqNumber(a+1);this.jainSipRegisterSentRequest.getExpires().setExpires(0);this.jainSipRegisterSentRequest=this.jainSipRegisterSentRequest=this.messageFactory.setNewViaHeader(this.jainSipRegisterSentRequest);this.jainSipRegisterTransaction=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest()}else{this.sipUnregisterPendingFlag=true}}else{this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}}else{console.error("PrivateJainSipClientConnector:close(): bad state, unauthorized action");throw"PrivateJainSipClientConnector:close(): bad state, unauthorized action"}}catch(c){console.error("PrivateJainSipClientConnector:close(): catched exception:"+c);throw c}};PrivateJainSipClientConnector.prototype.createPrivateCallConnector=function(d,a){console.debug("PrivateJainSipClientConnector:createPrivateCallConnector()");try{if(d instanceof WebRtcCommCall){if(this.openedFlag==true){var c=new PrivateJainSipCallConnector(d,a);this.callConnectors[c.sipCallId]=c;return c}else{console.error("PrivateJainSipClientConnector:createPrivateCallConnector(): bad state, unauthorized action");throw"PrivateJainSipClientConnector:createPrivateCallConnector(): bad state, unauthorized action"}}else{console.error("PrivateJainSipClientConnector:createPrivateCallConnector(): bad argument, check API documentation");throw"PrivateJainSipClientConnector:createPrivateCallConnector(): bad argument, check API documentation"}}catch(b){console.error("PrivateJainSipClientConnector:createPrivateCallConnector(): catched exception:"+b);throw b}};PrivateJainSipClientConnector.prototype.findCallConnector=function(a){console.debug("PrivateJainSipClientConnector:findCallConnector(): sipCallId="+a);return this.callConnectors[a]};PrivateJainSipClientConnector.prototype.removeCallConnector=function(a){console.debug("PrivateJainSipClientConnector:removeCallConnector(): sipCallId="+a);delete this.callConnectors.sipCallId};PrivateJainSipClientConnector.prototype.reset=function(){console.debug("PrivateJainSipClientConnector:reset()");this.openedFlag=false;this.configuration=undefined;this.resetSipRegisterContext();this.callConnectors={}};PrivateJainSipClientConnector.prototype.resetSipRegisterContext=function(){console.debug("PrivateJainSipClientConnector:resetSipRegisterContext()");if(this.sipRegisterRefreshTimer!=undefined){clearTimeout(this.sipRegisterRefreshTimer)}this.sipRegisterState=this.SIP_UNREGISTERED_STATE;this.sipRegisterRefreshTimer=undefined;this.sipRegisterAuthenticatedFlag=false;this.jainSipRegisterSentRequest=undefined;this.jainSipRegisterTransaction=undefined;this.sipUnregisterPendingFlag=false};PrivateJainSipClientConnector.prototype.checkConfiguration=function(c){console.debug("PrivateJainSipClientConnector:checkConfiguration()");try{var a=true;if(c.sipUserAgent==undefined||c.sipUserAgent.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipUserAgent")}if(c.sipOutboundProxy==undefined||c.sipOutboundProxy.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipOutboundProxy")}if(c.sipDomain==undefined||c.sipDomain.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipDomain")}if(c.sipUserName==undefined||c.sipUserName.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipUserName")}if(c.sipRegisterMode==undefined||c.sipRegisterMode.length==0){a=false;console.error("PrivateJainSipClientConnector:checkConfiguration(): missing configuration parameter sipRegisterMode")}if(c.sipLogin!=undefined&&c.sipLogin.length==0){c.sipLogin=undefined}if(c.sipPassword!=undefined&&c.sipPassword.length==0){c.sipPassword=undefined}if(c.sipApplicationProfile!=undefined&&c.sipApplicationProfile.length==0){c.sipApplicationProfile=undefined}console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipUserAgent:"+c.sipUserAgent);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipOutboundProxy:"+c.sipOutboundProxy);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipDomain:"+c.sipDomain);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipUserName:"+c.sipUserName);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipLogin:"+c.sipLogin);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipPassword: "+c.sipPassword);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipRegisterMode:"+c.sipRegisterMode);console.debug("PrivateJainSipClientConnector:checkConfiguration(): configuration.sipApplicationProfile:"+c.sipApplicationProfile);return a}catch(b){console.error("PrivateJainSipClientConnector:checkConfiguration(): catched exception:"+b);return false}};PrivateJainSipClientConnector.prototype.processConnected=function(){console.debug("PrivateJainSipClientConnector:processConnected()");try{if(this.openedFlag==false){if(this.configuration.sipRegisterMode==true){this.resetSipRegisterContext();var a=this.configuration.sipUserName+"@"+this.configuration.sipDomain;var m=this.headerFactory.createCSeqHeader(1,"REGISTER");var o=this.headerFactory.createCallIdHeader();var b=this.headerFactory.createExpiresHeader(3600);var i=this.headerFactory.createMaxForwardsHeader(70);var d=this.addressFactory.createSipURI_user_host(null,this.configuration.sipDomain);var l=this.headerFactory.createHeaders(PrivateJainSipClientConnector.prototype.SIP_ALLOW_HEADER);var c=this.addressFactory.createSipURI_user_host(null,a);var j=this.addressFactory.createAddress_name_uri(null,c);var f=new Date();var n=f.getTime();var k=this.headerFactory.createFromHeader(j,n);var g=this.headerFactory.createToHeader(j,null);var h=this.messageFactory.createRequest(d,"REGISTER",o,m,k,g,i);this.messageFactory.addHeader(h,b);this.messageFactory.addHeader(h,this.jainSipUserAgentHeader);this.messageFactory.addHeader(h,l);this.messageFactory.addHeader(h,this.jainSipContactHeader);this.jainSipRegisterSentRequest=h;this.jainSipRegisterTransaction=this.sipProvider.getNewClientTransaction(h);h.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest();this.sipRegisterState=this.SIP_REGISTERING_STATE;return}else{this.openedFlag=true;this.webRtcCommClient.onPrivateClientConnectorOpenedEvent();return}}else{console.error("PrivateJainSipClientConnector:processConnected(): this.openedFlag==true !")}this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}catch(e){this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent();console.error("PrivateJainSipClientConnector:processConnected(): catched exception:"+e)}};PrivateJainSipClientConnector.prototype.processDisconnected=function(){console.debug("PrivateJainSipClientConnector:processDisconnected(): SIP connectivity has been lost");try{this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}catch(a){console.error("PrivateJainSipClientConnector:processDisconnected(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.processConnectionError=function(a){console.war("PrivateJainSipClientConnector:processConnectionError(): SIP connection has failed, error:"+a);try{this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}catch(b){console.error("PrivateJainSipClientConnector:processConnectionError(): catched exception:"+b)}};PrivateJainSipClientConnector.prototype.processRequest=function(a){console.debug("PrivateJainSipClientConnector:processRequest()");try{var f=a.getRequest();var e=f.getMethod();if(e=="OPTIONS"){this.processSipOptionRequest(a)}else{var c=f.getCallId().getCallId();var g=this.findCallConnector(c);if(g){g.onJainSipClientConnectorSipRequestEvent(a)}else{if(e=="INVITE"){var b=new WebRtcCommCall(this.webRtcCommClient);b.connector=this.createPrivateCallConnector(b,c);b.id=b.connector.getId();b.connector.sipCallState=PrivateJainSipCallConnector.prototype.SIP_INVITED_INITIAL_STATE;b.connector.onJainSipClientConnectorSipRequestEvent(a)}else{console.warn("PrivateJainSipClientConnector:processRequest(): SIP request ignored")}}}}catch(d){console.error("PrivateJainSipClientConnector:processRequest(): catched exception:"+d)}};PrivateJainSipClientConnector.prototype.processResponse=function(b){console.debug("PrivateJainSipClientConnector:processResponse()");try{var d=b.getResponse();if(d.getCSeq().getMethod()=="REGISTER"){this.processSipRegisterResponse(b)}else{var c=this.findCallConnector(d.getCallId().getCallId());if(c){c.onJainSipClientConnectorSipResponseEvent(b)}else{console.warn("PrivateJainSipClientConnector:processResponse(): PrivateJainSipCallConnector not found, SIP response ignored")}}}catch(a){console.error("PrivateJainSipClientConnector:processResponse(): catched exception:"+a)}};PrivateJainSipClientConnector.prototype.processTransactionTerminated=function(){console.debug("PrivateJainSipClientConnector:processTransactionTerminated()")};PrivateJainSipClientConnector.prototype.processDialogTerminated=function(){console.debug("PrivateJainSipClientConnector:processDialogTerminated()")};PrivateJainSipClientConnector.prototype.processIOException=function(a){console.error("PrivateJainSipClientConnector:processIOException(): exceptionEvent="+a.message)};PrivateJainSipClientConnector.prototype.processTimeout=function(a){console.debug("PrivateJainSipClientConnector:processTimeout():timeoutEvent="+a);try{var d=a.getClientTransaction();var b=d.getDialog().getCallId().getCallId();var e=this.findCallConnector(b,false);if(e){e.onJainSipClientConnectorSipTimeoutEvent(a)}else{if(this.jainSipRegisterSentRequest.getCallId().getCallId()==b){console.error("PrivateJainSipClientConnector:processTimeout(): SIP registration failed, request timeout, no response from SIP server");this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent("Request Timeout")}else{console.warn("PrivateJainSipClientConnector:processTimeout(): no dialog found, SIP timeout ignored")}}}catch(c){console.error("PrivateJainSipClientConnector:processTimeout(): catched exception:"+c)}};PrivateJainSipClientConnector.prototype.onSipRegisterTimeout=function(){console.debug("PrivateJainSipClientConnector:onSipRegisterTimeout()");try{if(this.sipRegisterState==this.SIP_REGISTERED_STATE){this.sipRegisterRefreshTimer=undefined;this.sipRegisterState=this.SIP_REGISTER_REFRESHING_STATE;var a=new Number(this.jainSipRegisterSentRequest.getCSeq().getSeqNumber());this.jainSipRegisterSentRequest.getCSeq().setSeqNumber(a+1);this.jainSipRegisterSentRequest=this.messageFactory.setNewViaHeader(this.jainSipRegisterSentRequest);this.jainSipRegisterTransaction=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest()}else{console.warn("PrivateJainSipClientConnector:onSipRegisterTimeout(): SIP REGISTER refresh stopped")}}catch(b){console.error("PrivateJainSipClientConnector:onSipRegisterTimeout(): catched exception:"+b)}};PrivateJainSipClientConnector.prototype.processSipRegisterResponse=function(e){console.debug("PrivateJainSipClientConnector:processSipRegisterResponse(): this.sipRegisterState="+this.sipRegisterState);var f=e.getResponse();var c=parseInt(f.getStatusCode());if(this.sipRegisterState==this.SIP_UNREGISTERED_STATE){console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}else{if((this.sipRegisterState==this.SIP_REGISTERING_STATE)||(this.sipRegisterState==this.SIP_REGISTER_REFRESHING_STATE)){if(c<200){console.debug("PrivateJainSipClientConnector:processSipRegisterResponse(): 1XX response ignored")}else{if(c==401){if(this.configuration.sipPassword!=undefined&&this.configuration.sipLogin!=undefined){this.sipRegisterState=this.SIP_REGISTERING_401_STATE;this.jainSipRegisterSentRequest.removeHeader("Authorization");var b=new Number(this.jainSipRegisterSentRequest.getCSeq().getSeqNumber());this.jainSipRegisterSentRequest.getCSeq().setSeqNumber(b+1);var a=this.headerFactory.createAuthorizationHeader(f,this.jainSipRegisterSentRequest,this.configuration.sipPassword,this.configuration.sipLogin);this.messageFactory.addHeader(this.jainSipRegisterSentRequest,a);this.jainSipRegisterSentRequest=this.messageFactory.setNewViaHeader(this.jainSipRegisterSentRequest);this.jainSipRegisterTransaction=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest()}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP registration failed:"+f.getStatusCode()+"  "+f.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}}else{if(c==200){this.sipRegisterState=this.SIP_REGISTERED_STATE;if(this.openedFlag==false){this.openedFlag=true;this.webRtcCommClient.onPrivateClientConnectorOpenedEvent()}if(this.sipUnregisterPendingFlag==true){this.sipUnregisterPendingFlag=false;this.sipRegisterState=this.SIP_UNREGISTERING_STATE;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}var b=new Number(this.jainSipRegisterSentRequest.getCSeq().getSeqNumber());this.jainSipRegisterSentRequest.getCSeq().setSeqNumber(b+1);this.jainSipRegisterSentRequest.getExpires().setExpires(0);this.jainSipRegisterSentRequest=this.jainSipRegisterSentRequest=this.messageFactory.setNewViaHeader(this.jainSipRegisterSentRequest);this.jainSipRegisterTransaction=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest()}else{var d=this;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sipRegisterRefreshTimer=setTimeout(function(){d.onSipRegisterTimeout()},40000)}}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP registration failed:"+f.getStatusCode()+"  "+f.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}}}}else{if(this.sipRegisterState==this.SIP_REGISTERING_401_STATE){if(c<200){}else{if(c==200){this.sipRegisterState=this.SIP_REGISTERED_STATE;if(this.openedFlag==false){console.debug("PrivateJainSipClientConnector:processSipRegisterResponse(): this.openedFlag=true");this.openedFlag=true;this.webRtcCommClient.onPrivateClientConnectorOpenedEvent()}if(this.sipUnregisterPendingFlag==true){this.sipUnregisterPendingFlag=false;this.sipRegisterState=this.SIP_UNREGISTERING_STATE;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}var b=new Number(this.jainSipRegisterSentRequest.getCSeq().getSeqNumber());this.jainSipRegisterSentRequest.getCSeq().setSeqNumber(b+1);this.jainSipRegisterSentRequest.getExpires().setExpires(0);this.jainSipRegisterSentRequest=this.jainSipRegisterSentRequest=this.messageFactory.setNewViaHeader(this.jainSipRegisterSentRequest);this.jainSipRegisterTransaction=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest()}else{var d=this;if(this.sipRegisterRefreshTimer){clearTimeout(this.sipRegisterRefreshTimer)}this.sipRegisterRefreshTimer=setTimeout(function(){d.onSipRegisterTimeout()},40000)}}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP registration failed:"+f.getStatusCode()+"  "+f.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorOpenErrorEvent()}}}else{if(this.sipRegisterState==this.SIP_REGISTERED_STATE){console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}else{if(this.sipRegisterState==this.SIP_UNREGISTERING_STATE){if(c<200){}else{if(c==401){this.sipRegisterState=this.SIP_UNREGISTERING_401_STATE;this.jainSipRegisterSentRequest.removeHeader("Authorization");var b=new Number(this.jainSipRegisterSentRequest.getCSeq().getSeqNumber());this.jainSipRegisterSentRequest.getCSeq().setSeqNumber(b+1);var a=this.headerFactory.createAuthorizationHeader(f,this.jainSipRegisterSentRequest,this.configuration.sipPassword,this.configuration.sipLogin);this.messageFactory.addHeader(this.jainSipRegisterSentRequest,a);this.jainSipRegisterSentRequest=this.messageFactory.setNewViaHeader(this.jainSipRegisterSentRequest);this.jainSipRegisterTransaction=this.sipProvider.getNewClientTransaction(this.jainSipRegisterSentRequest);this.jainSipRegisterSentRequest.setTransaction(this.jainSipRegisterTransaction);this.jainSipRegisterTransaction.sendRequest()}else{if(c==200){this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP unregistration failed:"+f.getStatusCode()+"  "+f.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}}}}else{if(this.sipRegisterState==this.SIP_UNREGISTERING_401_STATE){if(c<200){}else{if(c==200){this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): SIP unregistration failed:"+f.getStatusCode()+"  "+f.getStatusLine());this.reset();this.webRtcCommClient.onPrivateClientConnectorClosedEvent()}}}else{if(this.sipRegisterState==this.SIP_UNREGISTERED_STATE){console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}else{console.error("PrivateJainSipClientConnector:processSipRegisterResponse(): bad state, SIP response ignored")}}}}}}}};PrivateJainSipClientConnector.prototype.processSipOptionRequest=function(a){console.debug("PrivateJainSipClientConnector:processSipOptionRequest()");var b=a.getRequest();var c=b.createResponse(200,"OK");c.addHeader(this.jainSipContactHeader);c.addHeader(this.jainSipUserAgentHeader);c.removeHeader("P-Asserted-Identity");c.removeHeader("P-Charging-Vector");c.removeHeader("P-Charging-Function-Addresses");c.removeHeader("P-Called-Party-ID");a.getServerTransaction().sendResponse(c)};WebRtcCommCall=function(a){if(a instanceof WebRtcCommClient){console.debug("WebRtcCommCall:WebRtcCommCall()");this.id=undefined;this.webRtcCommClient=a;this.calleePhoneNumber=undefined;this.callerPhoneNumber=undefined;this.configuration=undefined;this.connector=undefined;this.peerConnection=undefined;this.peerConnectionState=undefined;this.remoteMediaStream=undefined;this.remoteSdpOffer=undefined}else{throw"WebRtcCommCall:WebRtcCommCall(): bad arguments"}};WebRtcCommCall.prototype.isOpened=function(){if(this.connector){return this.connector.isOpened()}else{return false}};WebRtcCommCall.prototype.getId=function(){return this.id};WebRtcCommCall.prototype.getCallerPhoneNumber=function(){return this.callerPhoneNumber};WebRtcCommCall.prototype.getConfiguration=function(){return this.configuration};WebRtcCommCall.prototype.getCalleePhoneNumber=function(){return this.calleePhoneNumber};WebRtcCommCall.prototype.getRemoteMediaStream=function(){return this.remoteMediaStream};WebRtcCommCall.prototype.open=function(c,f){console.debug("WebRtcCommCall:open():calleePhoneNumber="+c);if(typeof(f)=="object"){if(this.webRtcCommClient.isOpened()){if(this.checkConfiguration(f)){if(this.isOpened()==false){try{this.calleePhoneNumber=c;this.configuration=f;this.connector.open(f);this.createRTCPeerConnection();this.peerConnection.addStream(this.configuration.localMediaStream);var b=this;if(window.webkitRTCPeerConnection){this.peerConnection.createOffer(function(e){b.processRtcPeerConnectionCreateOfferSuccess(e)},function(e){b.processRtcPeerConnectionCreateOfferError(e)})}else{if(window.mozRTCPeerConnection){this.peerConnection.createOffer(function(e){b.processRtcPeerConnectionCreateOfferSuccess(e)},function(e){b.processRtcPeerConnectionCreateOfferError(e)},{mandatory:{MozDontOfferDataChannel:true}})}}}catch(a){console.error("WebRtcCommCall:open(): catched exception:"+a);try{this.close()}catch(d){}throw a}}else{console.error("WebRtcCommCall:open(): bad state, unauthorized action");throw"WebRtcCommCall:open(): bad state, unauthorized action"}}else{console.error("WebRtcCommCall:open(): bad configuration");throw"WebRtcCommCall:open(): bad configuration"}}else{console.error("WebRtcCommCall:open(): bad state, unauthorized action");throw"WebRtcCommCall:open(): bad state, unauthorized action"}}else{console.error("WebRtcCommCall:open(): bad argument, check API documentation");throw"WebRtcCommCall:open(): bad argument, check API documentation"}};WebRtcCommCall.prototype.close=function(){console.debug("WebRtcCommCall:close()");if(this.webRtcCommClient.isOpened()){try{if(this.connector){this.connector.close()}if(this.peerConnection&&this.peerConnection.readyState!="closed"){this.peerConnection.close();this.peerConnection=undefined;var b=this;setTimeout(function(){b.webRtcCommClient.eventListener.onWebRtcCommCallClosedEvent(b)},1)}}catch(a){console.error("WebRtcCommCall:open(): catched exception:"+a)}}else{console.error("WebRtcCommCall:close(): bad state, unauthorized action");throw"WebRtcCommCall:close(): bad state, unauthorized action"}};WebRtcCommCall.prototype.accept=function(f){console.debug("WebRtcCommCall:accept()");if(typeof(f)=="object"){if(this.webRtcCommClient.isOpened()){if(this.checkConfiguration(f)){this.configuration=f;if(this.isOpened()==false){try{this.createRTCPeerConnection();this.peerConnection.addStream(this.configuration.localMediaStream);var d=undefined;if(window.webkitRTCPeerConnection){d=new RTCSessionDescription({type:"offer",sdp:this.remoteSdpOffer})}else{if(window.mozRTCPeerConnection){d={type:"offer",sdp:this.remoteSdpOffer}}}var b=this;this.peerConnectionState="offer-received";this.peerConnection.setRemoteDescription(d,function(){b.processRtcPeerConnectionSetRemoteDescriptionSuccess()},function(e){b.processRtcPeerConnectionSetRemoteDescriptionError(e)})}catch(a){console.error("WebRtcCommCall:accept(): catched exception:"+a);try{this.close()}catch(c){}throw a}}else{console.error("WebRtcCommCall:accept(): bad state, unauthorized action");throw"WebRtcCommCall:accept(): bad state, unauthorized action"}}else{console.error("WebRtcCommCall:accept(): bad configuration");throw"WebRtcCommCall:accept(): bad configuration"}}else{console.error("WebRtcCommCall:accept(): bad state, unauthorized action");throw"WebRtcCommCall:accept(): bad state, unauthorized action"}}else{console.error("WebRtcCommCall:accept(): bad argument, check API documentation");throw"WebRtcCommCall:accept(): bad argument, check API documentation"}};WebRtcCommCall.prototype.reject=function(){console.debug("WebRtcCommCall:reject()");if(this.webRtcCommClient.isOpened()){try{this.connector.reject()}catch(a){console.error("WebRtcCommCall:reject(): catched exception:"+a);try{this.close()}catch(b){}throw a}}else{console.error("WebRtcCommCall:reject(): bad state, unauthorized action");throw"WebRtcCommCall:reject(): bad state, unauthorized action"}};WebRtcCommCall.prototype.checkConfiguration=function(b){console.debug("WebRtcCommCall:checkConfiguration()");var a=true;if(b.localMediaStream==undefined){a=false;console.error("WebRtcCommCall:checkConfiguration(): missing localMediaStream")}if(b.audioMediaFlag==undefined||(typeof(b.audioMediaFlag)!="boolean")){a=false;console.error("WebRtcCommCall:checkConfiguration(): missing audio media flag")}if(b.videoMediaFlag==undefined||(typeof(b.videoMediaFlag)!="boolean")){a=false;console.error("WebRtcCommCall:checkConfiguration(): missing video media flag")}if(b.dataMediaFlag==undefined||(typeof(b.dataMediaFlag)!="boolean")){a=false;console.error("WebRtcCommCall:checkConfiguration(): missing data media flag")}console.debug("WebRtcCommCall:checkConfiguration(): configuration.displayedName="+b.displayedName);console.debug("WebRtcCommCall:checkConfiguration(): configuration.localMediaStream="+b.localMediaStream);console.debug("WebRtcCommCall:checkConfiguration(): configuration.audioMediaFlag="+b.audioMediaFlag);console.debug("WebRtcCommCall:checkConfiguration(): configuration.audioMediaFlag="+b.audioMediaFlag);console.debug("WebRtcCommCall:checkConfiguration(): configuration.dataMediaFlag="+b.dataMediaFlag);return a};WebRtcCommCall.prototype.createRTCPeerConnection=function(){console.debug("WebRtcCommCall:createPeerConnection()");var b={iceServers:[]};this.peerConnectionState="new";var a=this;if(this.configuration.stunServer){b={iceServers:[{url:this.webRtcCommClient.configuration.rtcPeerConnection.stunServer}]}}if(window.webkitRTCPeerConnection){this.peerConnection=new window.webkitRTCPeerConnection(b)}else{if(window.mozRTCPeerConnection){this.peerConnection=new window.mozRTCPeerConnection()}}this.peerConnection.onaddstream=function(c){a.processRtcPeerConnectionOnAddStream(c)};this.peerConnection.onremovestream=function(c){a.onRtcPeerConnectionOnRemoveStreamEvent(c)};this.peerConnection.onstatechange=function(c){a.onRtcPeerConnectionStateChangeEvent(c)};this.peerConnection.onicecandidate=function(c){a.onRtcPeerConnectionIceCandidateEvent(c)};this.peerConnection.ongatheringchange=function(c){a.onRtcPeerConnectionGatheringChangeEvent(c)};this.peerConnection.onicechange=function(c){a.onRtcPeerConnectionIceChangeEvent(c)};if((window.webkitRTCPeerConnection)){this.peerConnection.onopen=function(c){a.onRtcPeerConnectionOnOpenEvent(c)};this.peerConnection.onidentityresult=function(c){a.onRtcPeerConnectionIdentityResultEvent(c)};this.peerConnection.onnegotationneeded=function(c){a.onRtcPeerConnectionIceNegotationNeededEvent(c)}}};WebRtcCommCall.prototype.onPrivateCallConnectorRemoteSdpOfferEvent=function(a){console.debug("WebRtcCommCall:onPrivateCallConnectorSdpOfferEvent()");this.remoteSdpOffer=a};WebRtcCommCall.prototype.onPrivateCallConnectorRemoteSdpAnswerEvent=function(d){console.debug("WebRtcCommCall:onPrivateCallConnectorRemoteSdpAnswerEvent()");try{var c=undefined;if(window.webkitRTCPeerConnection){c=new RTCSessionDescription({type:"answer",sdp:d})}else{if(window.mozRTCPeerConnection){c={type:"answer",sdp:d}}}var b=this;this.peerConnectionState="answer-received";this.peerConnection.setRemoteDescription(c,function(){b.processRtcPeerConnectionSetRemoteDescriptionSuccess()},function(e){b.processRtcPeerConnectionSetRemoteDescriptionError(e)})}catch(a){console.error("WebRtcCommCall:onPrivateCallConnectorRemoteSdpAnswerEvent(): catched exception:"+a);throw a}};WebRtcCommCall.prototype.onPrivateCallConnectorCallOpenedEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallOpenedEvent()");if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenEvent){var a=this;setTimeout(function(){try{a.webRtcCommClient.eventListener.onWebRtcCommCallOpenEvent(a)}catch(b){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenedEvent(): catched exception in listener:"+b)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallInProgressEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallOpenedEvent()");if(this.webRtcCommClient.eventListener.onWebRtcCommCallInProgressEvent){var a=this;setTimeout(function(){try{a.webRtcCommClient.eventListener.onWebRtcCommCallInProgressEvent(a)}catch(b){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenedEvent(): catched exception in listener:"+b)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallOpenErrorEvent=function(a){console.debug("WebRtcCommCall:onPrivateCallConnectorCallOpenErrorEvent():error="+a);if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenErrorEvent){var b=this;setTimeout(function(){try{b.webRtcCommClient.eventListener.onWebRtcCommCallOpenErrorEvent(b,a)}catch(c){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+c)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallRingingEvent=function(a){console.debug("WebRtcCommCall:onPrivateCallConnectorCallRingingEvent():callerPhoneNumber="+a);if(this.webRtcCommClient.eventListener.onWebRtcCommCallRingingEvent){this.callerPhoneNumber=a;var b=this;setTimeout(function(){try{b.webRtcCommClient.eventListener.onWebRtcCommCallRingingEvent(b,b.callerPhoneNumber)}catch(c){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+c)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallRingingBackEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallRingingBackEvent()");if(this.webRtcCommClient.eventListener.onWebRtcCommCallRingingBackEvent){var a=this;setTimeout(function(){try{a.webRtcCommClient.eventListener.onWebRtcCommCallRingingBackEvent(a)}catch(b){console.error("WebRtcCommCall:onPrivateCallConnectorCallOpenErrorEvent(): catched exception in listener:"+b)}},1)}};WebRtcCommCall.prototype.onPrivateCallConnectorCallClosedEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallClosedEvent()");this.connector=undefined;try{this.close()}catch(a){}};WebRtcCommCall.prototype.onPrivateCallConnectorCallHangupEvent=function(){console.debug("WebRtcCommCall:onPrivateCallConnectorCallHangupEvent()");if(this.webRtcCommClient.eventListener.onWebRtcCommCallHangupEvent){var a=this;setTimeout(function(){try{a.webRtcCommClient.eventListener.onWebRtcCommCallHangupEvent(a)}catch(b){console.error("WebRtcCommCall:onPrivateCallConnectorCallHangupEvent(): catched exception in listener:"+b)}},1)}};WebRtcCommCall.prototype.processRtcPeerConnectionError=function(a){console.debug("WebRtcCommCall:processRtcPeerConnectionError(): error="+a);if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenErrorEvent){var c=this;setTimeout(function(){try{c.webRtcCommClient.eventListener.onWebRtcCommCallOpenErrorEvent(c,a)}catch(d){console.error("WebRtcCommCall:processRtcPeerConnectionError(): catched exception in listener:"+d)}},1)}try{this.close()}catch(b){}};WebRtcCommCall.prototype.processRtcPeerConnectionOnAddStream=function(c){try{var a=c.currentTarget;console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): event="+c);console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): peerConnection.readyState="+a.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): peerConnection.iceGatheringState="+a.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): peerConnection.iceState="+a.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnection!=undefined){this.remoteMediaStream=c.stream}}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionOnAddStream(): catched exception, exception:"+b);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.onRtcPeerConnectionOnRemoveStreamEvent=function(c){try{var a=c.currentTarget;console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): event="+c);console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): peerConnection.readyState="+a.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): peerConnection.iceGatheringState="+a.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): peerConnection.iceState="+a.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnection!=undefined){this.remoteMediaStream=undefined}}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionOnRemoveStream(): catched exception, exception:"+b);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.onRtcPeerConnectionIceCandidateEvent=function(d){try{var a=d.currentTarget;console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): rtcIceCandidateEvent="+d);console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): peerConnection.readyState="+a.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): peerConnection.iceGatheringState="+a.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): peerConnection.iceState="+a.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate():  this.peerConnectionState="+this.peerConnectionState);if(a.readyState!="closed"){if(d.candidate!=null){console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate: RTCIceCandidateEvent.candidate.candidate="+d.candidate.candidate)}else{console.debug("WebRtcCommCall:processRtcPeerConnectionIceCandidate: no anymore ICE candidate");if(window.webkitRTCPeerConnection){if(this.peerConnectionState=="preparing-offer"){this.connector.invite(this.peerConnection.localDescription.sdp);this.peerConnectionState="offer-sent"}else{if(this.peerConnectionState=="preparing-answer"){this.connector.accept(this.peerConnection.localDescription.sdp);this.peerConnectionState="established";if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent){var c=this;setTimeout(function(){try{c.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent(c)}catch(e){console.error("WebRtcCommCall:processInvitingSipRequest(): catched exception in listener:"+e)}},1)}}else{if(this.peerConnectionState=="established"){}else{console.error("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): RTCPeerConnection bad state!")}}}}}}else{console.error("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): RTCPeerConnection closed!")}}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionIceCandidate(): catched exception, exception:"+b);this.processRtcPeerConnectionError(b)}};WebRtcCommCall.prototype.processRtcPeerConnectionCreateOfferSuccess=function(c){try{console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): offer="+c.sdp);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="new"){var b=this;this.peerConnectionState="preparing-offer";this.peerConnectionLocalDescription=c;this.peerConnection.setLocalDescription(c,function(){b.processRtcPeerConnectionSetLocalDescriptionSuccess()},function(d){b.processRtcPeerConnectionSetLocalDescriptionError(d)})}else{console.error("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): RTCPeerConnection bad state!")}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionCreateOfferSuccess(): catched exception, exception:"+a);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionCreateOfferError=function(a){try{console.error("WebRtcCommCall:processRtcPeerConnectionCreateOfferError():error="+a);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): this.peerConnectionState="+this.peerConnectionState);throw"WebRtcCommCall:processRtcPeerConnectionCreateOfferError():error="+a}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionCreateOfferError(): catched exception, exception:"+b);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionSetLocalDescriptionSuccess=function(){try{console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess()");console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): this.peerConnectionState="+this.peerConnectionState);if(window.mozRTCPeerConnection){if(this.peerConnectionState=="preparing-offer"){this.connector.onPrivateCallConnectorSdpOffer(this.peerConnection.localDescription.sdp);this.peerConnectionState="offer-sent"}else{if(this.peerConnectionState=="preparing-answer"){var c=undefined;if(this.peerConnection.localDescription){c=this.peerConnection.localDescription.sdp}else{c=this.peerConnectionLocalDescription.sdp}this.connector.onPrivateCallConnectorRemoteSdpAnswerEvent(c);this.peerConnectionState="established";if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent){var b=this;setTimeout(function(){try{b.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent(b)}catch(d){console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): catched exception in listener:"+d)}},1)}}else{if(this.peerConnectionState=="established"){}else{console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): RTCPeerConnection bad state!")}}}}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): catched exception, exception:"+a);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionSetLocalDescriptionError=function(a){try{console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError():error="+a);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): this.peerConnectionState="+this.peerConnectionState);throw"WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError():error="+a}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionError(): catched exception, exception:"+b);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionCreateAnswerSuccess=function(c){try{console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess():answer.sdp="+c.sdp);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="offer-received"){var b=this;this.peerConnectionState="preparing-answer";this.peerConnectionLocalDescription=c;this.peerConnection.setLocalDescription(c,function(){b.processRtcPeerConnectionSetLocalDescriptionSuccess()},function(d){b.processRtcPeerConnectionSetLocalDescriptionError(d)})}else{console.error("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): RTCPeerConnection bad state!")}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionCreateAnswerSuccess(): catched exception, exception:"+a);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionCreateAnswerError=function(a){console.error("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError():error="+a);try{console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): this.peerConnectionState="+this.peerConnectionState)}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionCreateAnswerError(): catched exception, exception:"+b);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionSetRemoteDescriptionSuccess=function(){try{console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): this.peerConnectionState="+this.peerConnectionState);if(this.peerConnectionState=="answer-received"){this.peerConnectionState="established";if(this.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent){var b=this;setTimeout(function(){try{b.webRtcCommClient.eventListener.onWebRtcCommCallOpenedEvent(b)}catch(c){console.error("WebRtcCommCall:processRtcPeerConnectionSetLocalDescriptionSuccess(): catched exception in listener:"+c)}},1)}}else{if(this.peerConnectionState=="offer-received"){var b=this;if(window.webkitRTCPeerConnection){this.peerConnection.createAnswer(function(c){b.processRtcPeerConnectionCreateAnswerSuccess(c)},function(c){b.processRtcPeerConnectionCreateAnswerError(c)})}else{if(window.mozRTCPeerConnection){this.peerConnection.createAnswer(function(c){b.processRtcPeerConnectionCreateAnswerSuccess(c)},function(c){b.processRtcPeerConnectionCreateAnswerError(c)},{mandatory:{MozDontOfferDataChannel:true}})}}}else{console.error("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): RTCPeerConnection bad state!")}}}catch(a){console.error("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionSuccess(): catched exception, exception:"+a);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.processRtcPeerConnectionSetRemoteDescriptionError=function(a){try{console.error("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError():error="+a);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): this.peerConnection.readyState="+this.peerConnection.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): this.peerConnection.iceGatheringState="+this.peerConnection.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): this.peerConnection.iceState="+this.peerConnection.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): this.peerConnectionState="+this.peerConnectionState);throw"WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError():error="+a}catch(b){console.error("WebRtcCommCall:processRtcPeerConnectionSetRemoteDescriptionError(): catched exception, exception:"+b);this.processRtcPeerConnectionError()}};WebRtcCommCall.prototype.onRtcPeerConnectionOnOpenEvent=function(b){console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen(): event="+b);var a=b.currentTarget;console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen():this.peerConnection.readyState="+a.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen(): this.peerConnection.iceGatheringState="+a.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen(): this.peerConnection.iceState="+a.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionOnOpen(): this.peerConnectionState="+this.peerConnectionState)};WebRtcCommCall.prototype.onRtcPeerConnectionStateChangeEvent=function(b){console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): event="+b);var a=b.currentTarget;console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): peerConnection.readyState="+a.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): peerConnection.iceGatheringState="+a.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): peerConnection.iceState="+a.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionStateChange(): this.peerConnectionState="+this.peerConnectionState);if(a&&a.readyState=="closed"){this.peerConnection=null}};WebRtcCommCall.prototype.onRtcPeerConnectionIceNegotationNeededEvent=function(b){console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded():event="+b);var a=b.currentTarget;console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded(): this.peerConnection.readyState="+a.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded(): this.peerConnection.iceGatheringState="+a.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded(): this.peerConnection.iceState="+a.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceNegotationNeeded(): this.peerConnectionState="+this.peerConnectionState)};WebRtcCommCall.prototype.onRtcPeerConnectionGatheringChangeEvent=function(b){console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange():event="+b);var a=b.currentTarget;console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange(): peerConnection.readyState="+a.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange(): peerConnection.iceGatheringState="+a.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange(): peerConnection.iceState="+a.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionGatheringChange(): this.peerConnectionState="+this.peerConnectionState)};WebRtcCommCall.prototype.onRtcPeerConnectionIceChangeEvent=function(b){console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange():event="+b);var a=b.currentTarget;console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange(): peerConnection.readyState="+a.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange(): peerConnection.iceGatheringState="+a.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange(): peerConnection.iceState="+a.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionIceChange(): this.peerConnectionState="+this.peerConnectionState)};WebRtcCommCall.prototype.onRtcPeerConnectionIdentityResultEvent=function(b){console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult():event="+b);var a=b.currentTarget;console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult(): peerConnection.readyState="+a.readyState);console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult(): peerConnection.iceGatheringState="+a.iceGatheringState);console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult(): peerConnection.iceState="+a.iceState);console.debug("WebRtcCommCall:processRtcPeerConnectionIdentityResult(): this.peerConnectionState="+this.peerConnectionState)};WebRtcCommClient=function(a){if(typeof a=="object"){this.id="WebRtcCommClient"+Math.floor(Math.random()*2147483648);console.debug("WebRtcCommClient:WebRtcCommClient():this.id="+this.id);this.eventListener=a;this.configuration=undefined;this.connector=undefined;this.closePendingFlag=false}else{throw"WebRtcCommClient:WebRtcCommClient(): bad arguments"}};WebRtcCommClient.prototype.SIP="SIP";WebRtcCommClient.prototype.isOpened=function(){if(this.connector){return this.connector.isOpened()}else{return false}};WebRtcCommClient.prototype.getConfiguration=function(){return this.configuration};WebRtcCommClient.prototype.open=function(a){console.debug("WebRtcCommClient:open()");if(typeof(a)=="object"){if(this.isOpened()==false){if(this.checkConfiguration(a)==true){this.configuration=a;if(a.communicationMode==WebRtcCommClient.prototype.SIP){this.connector=new PrivateJainSipClientConnector(this);this.connector.open(this.configuration.sip)}}else{console.error("WebRtcCommClient:open(): bad configuration");throw"WebRtcCommClient:open(): bad configuration"}}else{console.error("WebRtcCommClient:open(): bad state, unauthorized action");throw"WebRtcCommClient:open(): bad state, unauthorized action"}}else{console.error("WebRtcCommClient:open(): bad argument, check API documentation");throw"WebRtcCommClient:open(): bad argument, check API documentation"}};WebRtcCommClient.prototype.close=function(){console.debug("WebRtcCommClient:close()");if(this.isOpened()){try{this.closePendingFlag=true;this.connector.close()}catch(a){console.error("WebRtcCommClient:close(): catched exception:"+a);this.closePendingFlag=false;this.connector=undefined;if(this.eventListener.onWebRtcCommClientClosedEvent!=undefined){var b=this;setTimeout(function(){try{b.eventListener.onWebRtcCommClientClosedEvent(b)}catch(c){console.error("WebRtcCommClient:onWebRtcCommClientClosed(): catched exception in event listener:"+c)}},1)}}}};WebRtcCommClient.prototype.call=function(c,d){console.debug("WebRtcCommClient:call():calleePhoneNumber="+c);console.debug("WebRtcCommClient:call():callConfiguration="+d);try{if(typeof(c)=="string"&&typeof(d)=="object"){if(this.isOpened()){var a=new WebRtcCommCall(this);a.connector=this.connector.createPrivateCallConnector(a);a.id=a.connector.getId();a.open(c,d);return a}else{console.error("WebRtcCommClient:call(): bad state, unauthorized action");throw"WebRtcCommClient:call(): bad state, unauthorized action"}}else{console.error("WebRtcCommClient:call(): bad argument, check API documentation");throw"WebRtcCommClient:call(): bad argument, check API documentation"}}catch(b){console.error("WebRtcCommClient:call(): catched exception:"+b);throw b}};WebRtcCommClient.prototype.checkConfiguration=function(a){console.debug("WebRtcCommClient:checkConfiguration()");if(a.communicationMode!=undefined){if(a.communicationMode==WebRtcCommClient.prototype.SIP){return true}}return false};WebRtcCommClient.prototype.onPrivateClientConnectorOpenedEvent=function(){console.debug("WebRtcCommClient:onPrivateClientConnectorOpenedEvent()");if(this.eventListener.onWebRtcCommClientOpenedEvent!=undefined){var a=this;setTimeout(function(){try{a.eventListener.onWebRtcCommClientOpenedEvent()}catch(b){console.error("WebRtcCommClient:onPrivateClientConnectorOpenedEvent(): catched exception in event listener:"+b)}},1)}};WebRtcCommClient.prototype.onPrivateClientConnectorOpenErrorEvent=function(a){console.debug("WebRtcCommClient:onPrivateClientConnectorOpenErrorEvent():error:"+a);try{this.close()}catch(b){}if(this.eventListener.onWebRtcCommClientOpenErrorEvent!=undefined){var c=this;setTimeout(function(){try{c.eventListener.onWebRtcCommClientOpenErrorEvent(a)}catch(d){console.error("WebRtcCommClient:onPrivateClientConnectorOpenErrorEvent(): catched exception in event listener:"+d)}},1)}};WebRtcCommClient.prototype.onPrivateClientConnectorClosedEvent=function(){console.debug("WebRtcCommClient:onPrivateClientConnectorClosedEvent()");var c=this.isOpened()||this.closePendingFlag;try{if(this.closePendingFlag==false){this.close()}else{this.connector=undefined}}catch(a){}if(c&&this.eventListener.onWebRtcCommClientClosedEvent!=undefined){var b=this;setTimeout(function(){try{b.eventListener.onWebRtcCommClientClosedEvent()}catch(d){console.error("WebRtcCommClient:onPrivateClientConnectorClosedEvent(): catched exception in event listener:"+d)}},1)}else{if(!c&&this.eventListener.onWebRtcCommClientOpenErrorEvent!=undefined){var b=this;setTimeout(function(){try{b.eventListener.onWebRtcCommClientOpenErrorEvent("Connection to WebRtcCommServer has failed")}catch(d){console.error("WebRtcCommClient:onWebRtcCommClientOpenErrorEvent(): catched exception in event listener:"+d)}},1)}}};