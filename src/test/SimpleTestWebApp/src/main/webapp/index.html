<html>
    <head>
        <title>SimpleTestWebApp</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="./jain-sip.js" type="text/javascript"></script>      
        <script src="./SimpleWebRtcSipPhone.js" type="text/javascript" ></script>
        <script type="text/javascript">	
            
            // Test domain 
            var simpleWebRtcSipPhone=null;
            var sipWsUrl="ws://localhost:5082/";
                   
            // test URL http://localhost:8080/SimpleTestWebApp/?sipDomain=sipasf.fr&sipLogin=1111@sipasf.fr&sipPassword=1234&sipUserName=1111&sipDisplayName=lolo&sipContactUserName=2222
            
            // SIP profile
            var sipDomain=undefined;
            var sipDisplayName=undefined;
            var sipUserName=undefined;
            var sipLogin=undefined;
            var sipPassword=undefined;
            var sipDomain=undefined;
            var sipContactUserName=undefined;
                        
            if(location.search.length>0)
            {
                var argumentsString = location.search.substring(1);
                var arguments = argumentsString.split('&');
                if(arguments.length==0) arguments = [argumentsString];
                for(var i=0;i<arguments.length;i++)
                {   
                    var argument = arguments[i].split("=");
                    if("sipUserName"==argument[0])
                    {
                        sipUserName =argument[1];
                    } else if("sipDomain"==argument[0])
                    {
                        sipDomain =argument[1];
                    } else if("sipDisplayName"==argument[0])
                    {
                        sipDisplayName =argument[1];
                    } else if("sipPassword"==argument[0])
                    {
                        sipPassword =argument[1];
                    } else if("sipLogin"==argument[0])
                    {
                        sipLogin =argument[1];
                    }  else if("sipContactUserName"==argument[0])
                    {
                        sipContactUserName =argument[1];
                    }
                }
            }
           
            var defaultStunServer="";         
            var localAudioVideoMediaStream=null;
            var localAudioMediaStream=null;
            var localVideoMediaStream=null;
            
            function onLoad()
            {
                console.debug("onLoad");
                        
                hideRejectButton();
                hideAcceptButton();
                hideCallButton();
                hideByeButton();
                hideCancelButton();
                hideUnRegisterButton();
                hideRegisterButton();
            
                document.getElementById("stunServer").value=defaultStunServer;
                document.getElementById("sipWsUrl").value=sipWsUrl;
                document.getElementById("sipDomain").value=sipDomain;
                document.getElementById("sipDisplayName").value=sipDisplayName;
                document.getElementById("sipUserName").value=sipUserName;
                document.getElementById("sipLogin").value=sipLogin;
                document.getElementById("sipPassword").value=sipPassword;
                document.getElementById("sipContactPhoneNumber").value=sipContactUserName;
                if(navigator.webkitGetUserMedia)
                    navigator.webkitGetUserMedia({audio:true, video:true},webkitGetUserMediaSuccess, webkitGetUserMediaError);
                else if(navigator.mozGetUserMedia)
                {
                    navigator.mozGetUserMedia({audio:true},mozGetUserAudioMediaSuccess, mozGetUserMediaError);
                }

            }

            function onBeforeUnload()
            {
                unRegister();
                for(var i=0;i<5000;i++)
                {
                    console.log("OnBeforeUnLoad()");  
                }     
            }
            
            function webkitGetUserMediaSuccess (localStream) {
                try
                {
                    console.debug("webkitGetUserMediaSuccess localStream.id="+localStream.id);
                    if(localStream.getAudioTracks) console.debug("webkitGetUserMediaSuccess localStream.getAudioTracks()="+localStream.getAudioTracks());
                    else console.info("MediaStream:getAudioTracks() not supported")
                    if(localStream.getVideoTracks) console.debug("webkitGetUserMediaSuccess localStream.getVideoTracks()="+localStream.getVideoTracks());
                    else console.info("MediaStream:getVideoTracks() not supported")
                    localAudioVideoMediaStream=localStream;
                    document.getElementById("localVideoPreview").src=webkitURL.createObjectURL(localStream);
                    document.getElementById("localVideoPreview").play();
                    showRegisterButton();
                   
                }
                catch(exception)
                {
                    console.debug("mozGetUserMediaSuccess: catched exception: "+exception);
                    hideRegisterButton();
                }
            }
            
            
            function  webkitGetUserMediaError(code) 
            {
                console.debug("webkitGetUserMediaError");
                alert("Failed to get access to local media. Error code was " + code + ".");
            }	
    
            function mozGetUserVideoMediaSuccess (localStream) {
                try
                {
                    console.debug("mozGetUserVideoMediaSuccess localStream.id="+localStream.id);
                    if(localStream.getAudioTracks) console.debug("mozGetUserMediaSuccess: localStream.getAudioTracks()="+localStream.getAudioTracks());
                    else console.info("MediaStream:getAudioTracks() not supported")
                    if(localStream.getVideoTracks) console.debug("mozGetUserMediaSuccess: localStream.getVideoTracks()="+localStream.getVideoTracks());
                    else console.info("MediaStream:getVideoTracks() not supported")
                    localVideoMediaStream=localStream;
                    document.getElementById("localVideoPreview").mozSrcObject=localVideoMediaStream;
                    document.getElementById("localVideoPreview").play();
                    showRegisterButton();
                }
                catch(exception)
                {
                    console.debug("mozGetUserVideoMediaSuccess catched exception: "+exception);
                    hideRegisterButton();
                }
            }
            
            function mozGetUserAudioMediaSuccess (localStream) {
                try
                {
                    console.debug("mozGetUserAudioMediaSuccess localStream.id="+localStream.id);
                    if(localStream.getAudioTracks) console.debug("mozGetUserMediaSuccess: localStream.getAudioTracks()="+localStream.getAudioTracks());
                    else console.info("MediaStream:getAudioTracks() not supported")
                    if(localStream.getVideoTracks) console.debug("mozGetUserMediaSuccess: localStream.getVideoTracks()="+localStream.getVideoTracks());
                    else console.info("MediaStream:getVideoTracks() not supported")
                    localAudioMediaStream=localStream;
                    navigator.mozGetUserMedia({video:true},mozGetUserVideoMediaSuccess, mozGetUserMediaError);
                }
                catch(exception)
                {
                    console.debug("mozGetUserAudioMediaSuccess catched exception: "+exception);
                    hideRegisterButton();
                }
            }
                    

            function  mozGetUserMediaError(code) 
            {
                console.debug("mozGetUserMediaError");
                alert("Failed to get access to local media. Error code was " + code + ".");
            }	
            
    
            function register()
            {   
                var configuration = {
                    stunServer:document.getElementById("stunServer").value,
                    sipOutboundProxy:document.getElementById("sipWsUrl").value,
                    sipDomain: document.getElementById("sipDomain").value,
                    sipDisplayName: document.getElementById("sipDisplayName").value,
                    sipUserName: document.getElementById("sipUserName").value,
                    sipLogin: document.getElementById("sipLogin").value,
                    sipPassword: document.getElementById("sipPassword").value,
                    sipRegisterMode:document.getElementById("sipRegistrationCkeckBox").checked,
                    localAudioVideoMediaStream:localAudioVideoMediaStream,
                    localAudioMediaStream:localAudioMediaStream,
                    localVideoMediaStream:localVideoMediaStream,
                    audioMediaFlag:document.getElementById("audioMediaCkeckBox").checked,
                    videoMediaFlag:document.getElementById("videoMediaCkeckBox").checked
                }
                simpleWebRtcSipPhone=new SimpleWebRtcSipPhone(configuration);
            }

            function unRegister()
            {
                if(simpleWebRtcSipPhone!=null)
                {
                    simpleWebRtcSipPhone.unRegister();   
                }
            }

            function call(to)
            {   
                if(simpleWebRtcSipPhone==null) 
                {
                    var configuration = {
                        stunServer:document.getElementById("stunServer").value,
                        sipOutboundProxy:document.getElementById("sipWsUrl").value,
                        sipDomain: document.getElementById("sipDomain").value,
                        sipDisplayName: document.getElementById("sipDisplayName").value,
                        sipUserName: document.getElementById("sipUserName").value,
                        sipLogin: document.getElementById("sipLogin").value,
                        sipPassword: document.getElementById("sipPassword").value,
                        sipRegisterMode:document.getElementById("sipRegistrationCkeckBox").checked,
                        localAudioVideoMediaStream:localAudioVideoMediaStream,
                        localAudioMediaStream:localAudioMediaStream,
                        localVideoMediaStream:localVideoMediaStream,
                        audioMediaFlag:document.getElementById("audioMediaCkeckBox").checked,
                        videoMediaFlag:document.getElementById("videoMediaCkeckBox").checked
                    }
                    simpleWebRtcSipPhone=new SimpleWebRtcSipPhone(configuration);
                }
                else simpleWebRtcSipPhone.call(to);
            }


            function acceptCall()
            {
                simpleWebRtcSipPhone.acceptCall();
            }
                

            function rejectCall()
            {
                simpleWebRtcSipPhone.rejectCall();
            }
                
            function cancelCall()
            {
                simpleWebRtcSipPhone.cancelCall();
            }
                
            function byeCall()
            {
                simpleWebRtcSipPhone.byeCall();
            }
       
            function changeSipRegisterMode()
            {
                if(document.getElementById("sipRegistrationCkeckBox").checked==false)
                {
                    hideRejectButton();
                    hideAcceptButton();
                    showCallButton();
                    hideByeButton();
                    hideCancelButton();
                    hideUnRegisterButton();
                    hideRegisterButton();
                }
                else
                {
                    hideRejectButton();
                    hideAcceptButton();
                    hideCallButton();
                    hideByeButton();
                    hideCancelButton();
                    hideUnRegisterButton();
                    showRegisterButton();     
                }
            }
         
            function showCallButton()
            {
                document.getElementById("CallButton").disabled=false;
            }
            
            function showByeButton()
            {
                document.getElementById("ByeButton").disabled=false;
            }
            
            function showCancelButton()
            {
                document.getElementById("CancelButton").disabled=false;
            }
            
            function showAcceptButton()
            {
                document.getElementById("AcceptButton").disabled=false;
            }
            
            function showRejectButton()
            {
                document.getElementById("RejectButton").disabled=false;
            }
            
            function showUnRegisterButton()
            {
                document.getElementById("UnRegisterButton").disabled=false;
                hideSipRegisterModeButton();
            }
            
            function showRegisterButton()
            {
                document.getElementById("RegisterButton").disabled=false;
                document.getElementById("sipRegistrationCkeckBox").disabled=true;
                showSipRegisterModeButton();
            }
            
            function showSipRegisterModeButton()
            {
                document.getElementById("sipRegistrationCkeckBox").disabled=false;
            }
            
            function hideUnRegisterButton()
            {
                document.getElementById("UnRegisterButton").disabled=true;
            }
            
            function hideRegisterButton()
            {
                document.getElementById("RegisterButton").disabled=true;
            }
                   
            function hideCallButton()
            {
                document.getElementById("CallButton").disabled=true;
            }
           
            function hideByeButton()
            {
                document.getElementById("ByeButton").disabled=true;
            }
            
            function hideCancelButton()
            {
                document.getElementById("CancelButton").disabled=true;
            }
            
            function hideAcceptButton()
            {
                document.getElementById("AcceptButton").disabled=true;
            }
            
            function hideRejectButton()
            {
                document.getElementById("RejectButton").disabled=true;
            }
            
            function hideSipRegisterModeButton()
            {
                document.getElementById("sipRegistrationCkeckBox").disabled=true;
            }
           
        </script>
        <style type='text/css'>
            div {
                border: 0px solid black;
            }

            div#input {
                clear: both;
                width: 36em;
                padding: 4px;
                background-color: #e0e0e0;
                border: 1px solid black;
            }

            div.hidden {
                display: none;
            }

            span.alert {
                font-style: italic;
            }
        </style>
    </head>
    <body onload="onLoad()" onbeforeunload="onBeforeUnload()">
        <div style=" color: red">With Firefox, don't forget to set your about:config preferences! </div>
        <a href="http://localhost:8080/SimpleTestWebApp/?sipDomain=sipasf.fr&sipLogin=1111@sipasf.fr&sipPassword=1234&sipUserName=1111&sipDisplayName=lolo&sipContactUserName=2222">
            http://localhost:8080/SimpleTestWebApp/?sipDomain=sipasf.fr&sipLogin=1111@sipasf.fr&sipPassword=1234&sipUserName=1111&sipDisplayName=lolo&sipContactUserName=2222
        </a>
        <div id="sipAccountSettings" >
            <div id='stunServerDiv'>
                <label>STUN server:</label>
                <input  id="stunServer"  type="text" size="40" > 
            </div>
            <div id='sipWsUrlDiv'>
                <label>SIP outbound proxy WS URL:</label>
                <input  id="sipWsUrl"  type="text" size="40"> 
            </div>
            <div id='sipDomainDiv'>
                <label>SIP Domain:</label>
                <input id="sipDomain"  type="text" size="30"> 
            </div>           
            <div id='sipDisplayNameDiv'>
                <label>SIP Display Name:</label>
                <input id="sipDisplayName"  type="text" size="30" > 
            </div>
            <div id='sipUserNameDiv'>
                <label>SIP User Name:</label>
                <input id="sipUserName"  type="text" size="30"> 
            </div>
            <div id='sipLoginDiv'>
                <label>SIP Login:</label>
                <input id="sipLogin"   type="text" size="30"> 
            </div>
            <div id='sipPasswordDiv'>
                <label>SIP Password:</label>
                <input id="sipPassword"   type="password" size="30"> 
            </div>
            <div id='sipContactPhoneNumberDiv'>
                <label>SIP Contact phone number:</label>
                <input id="sipContactPhoneNumber"  type="text" size="30" > 
            </div>
            <div id='sipRegisterModeDiv'>
                <label>SIP REGISTER required:</label>
                <input  id='sipRegistrationCkeckBox' type="checkbox" checked name="sipRegistrationCkeckBox" onclick ="changeSipRegisterMode();">
            </div>
            <div id='audioMediaDiv'>
                <label>Audio media:</label>
                <input  id='audioMediaCkeckBox' type="checkbox" checked name="audioMediaCkeckBox">
            </div>
            <div id='audioMediaDiv'>
                <label>Video media:</label>
                <input  id='videoMediaCkeckBox' type="checkbox" checked name="videoMediaCheckBox" >
            </div>
        </div>
        <div id='input'>
            <div>
                <input id='RegisterButton' class='button' type='submit' name='RegisterButton' disabled value='Register' onclick = "register();"/>
                <input id='UnRegisterButton' class='button' type='submit' name='UnRegisterButton'  value='UnRegister' disabled onclick = "unRegister();"/>
                <input id='CallButton' class='button' type='submit' name='CallButton' value='Call' disabled onclick = "call(document.getElementById('sipContactPhoneNumber').value);"/>
                <input id='CancelButton' class='button' type='submit' name='CancelButton' value='Cancel' disabled onclick = "cancelCall();"/>
                <input id='AcceptButton' class='button' type='submit' name='AcceptButton' value='Accept' disabled onclick = "acceptCall();"/>
                <input id='RejectButton' class='button' type='submit' name='RejectButton' value='Reject' disabled onclick = "rejectCall();"/>
                <input id='ByeButton' class='button' type='submit' name='Bye' value='Bye' disabled onclick = "byeCall();"/>
            </div>
        </div>
        <div id='media'>
            <div>
                <video id="localVideoPreview" autoplay="autoplay" style="height:100px; width:100px"></video>  
            </div>
            <div>
                <video id="remoteVideo" autoplay="autoplay" style="height:100px; width:100px"></video>  
            </div>
        </div>
    </body>
</html>